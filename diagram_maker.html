<!DOCTYPE html>
<html>
<head>
    <title>MBTA Diversion Graphic Tool</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.7.1/svg.min.js"></script>
    <style type="text/css">
        .container {
            border: 1px solid black;
            display: inline-block;
            padding: 8px;
        }
    </style>
</head>
<body>
    <div style="display: flex;">
        <table id="style-container" class="container" style="border: none;"></table>
        <div id="drawing"></div>
    </div>
    <div id="lines">
    </div>
    
    <canvas id="canvas" style="opacity: 0;"></canvas>

    <script type="text/javascript">
        var state = null;

        document.addEventListener("DOMContentLoaded", function() {
            state = NEWTON_HIGHLANDS_KENMORE_STATE;
            buildDOMFromState(state);
        });

        var RT2 = Math.sqrt(2);
        var STATION_TEXT_ANGLE = 315; // Degrees
        var COLOR_OPTIONS = [
            { value: "red" , name: "Red Line"},
            { value: "orange" , name: "Orange Line"},
            { value: "green" , name: "Green Line"},
            { value: "blue" , name: "Blue Line"},
            { value: "purple" , name: "Commuter Rail"},
            { value: "silver" , name: "Silver Line"},
            { value: "bus" , name: "Bus"},
        ];
        var STATION_ATTRIBUTES = ["accessible", "skipped"];

        var STYLE_ATTRIBUTES = [
            { id: "padding", attribute: "padding", type: "number", label: "Padding", default: 20 },
            { id: "station-text-size", attribute: "stationTextSize", type: "number", label: "Station Text Size", default: 24 },
            { id: "arrow-text-size", attribute: "arrowTextSize", type: "number", label: "Arrow Text Size", default: 16 },
            { id: "line-stroke", attribute: "lineStroke", type: "number", label: "Line Stroke", default: 20 },
            { id: "line-dasharray", attribute: "lineDasharray", type: "text", label: "Line Dash Array", default: "30, 10" },
            { id: "line-extra-space", attribute: "lineExtraSpace", type: "number", label: "Line Extra Space", default: 6 },
            { id: "station-radius", attribute: "stationRadius", type: "number", label: "Station Radius", default: 24 },
            { id: "station-stroke", attribute: "stationStroke", type: "number", label: "Station Stroke", default: 6 },
        ];

        var DEFAULT_STYLE = {};
        for (var i = 0; i < STYLE_ATTRIBUTES.length; i++) {
            var style = STYLE_ATTRIBUTES[i];
            DEFAULT_STYLE[style.attribute] = style.default;
        }

        var DEFAULT_SELECTED = {
            routePattern: null,
            direction: null,
            fromStop: null,
            toStop: null
        };

        // Adapted from https://stackoverflow.com/questions/28226677/save-inline-svg-as-jpeg-png-svg
        function save() {
            var downloadWidth = parseInt(document.getElementById("download-width").value);

            var svg = document.querySelector('svg');
            var svgWidth = svg.width.baseVal.value;
            var svgHeight = svg.height.baseVal.value;
            var scaleFactor = downloadWidth / svgWidth;

            var canvas = document.getElementById('canvas');
            canvas.width = svgWidth * scaleFactor;
            canvas.height = svgHeight * scaleFactor;

            var ctx = canvas.getContext('2d');
            ctx.scale(scaleFactor, scaleFactor);
            var data = (new XMLSerializer()).serializeToString(svg);

            var DOMURL = window.URL || window.webkitURL || window;

            var img = new Image();
            var svgBlob = new Blob([data], {type: 'image/svg+xml;charset=utf-8'});
            var url = DOMURL.createObjectURL(svgBlob);

            img.onload = function () {
                ctx.drawImage(img, 0, 0);
                DOMURL.revokeObjectURL(url);

                var imgURI = canvas
                    .toDataURL('image/png')
                    .replace('image/png', 'image/octet-stream');

                var evt = new MouseEvent('click', {
                    view: window,
                    bubbles: false,
                    cancelable: true
                });

                var a = document.createElement('a');
                a.setAttribute('download', 'shuttle-diagram.png');
                a.setAttribute('href', imgURI);
                a.setAttribute('target', '_blank');

                a.dispatchEvent(evt);
            };

            img.src = url;
        }

        function copy(obj) {
            return JSON.parse(JSON.stringify(obj));
        }

        function getStyleFromDOM() {
            var styleState = {};
            for (var i = 0; i < STYLE_ATTRIBUTES.length; i++) {
                var style = STYLE_ATTRIBUTES[i];
                var value = document.getElementById(style.id).value;
                if (style.type == "number") {
                    value = parseInt(value);
                } else if (state.type == "textarea") {
                    value = value.trim().split("\n");
                }

                styleState[style.attribute] = value;
            }

            return styleState;
        }

        function getSelectedFromDOM(prefix) {
            var selectedState = {};

            selectedState.routePattern = document.getElementById(prefix + "-route-pattern").value;
            selectedState.direction = document.getElementById(prefix + "-route-direction").value;
            selectedState.fromStop = document.getElementById(prefix + "-station-from-stop").value;
            selectedState.toStop = document.getElementById(prefix + "-station-to-stop").value;

            if (selectedState.routePattern == "null") { selectedState.routePattern = null; }
            if (selectedState.direction == "null") { selectedState.direction = null; }
            if (selectedState.fromStop == "null") { selectedState.fromStop = null; }
            if (selectedState.toStop == "null") { selectedState.toStop = null; }

            // Set default values for stop dropdowns
            if (selectedState.routePattern !== null) {
                var directions = ROUTE_PATTERNS[selectedState.routePattern].directions;
                if (selectedState.direction === null) {
                    selectedState.direction = directions[0];
                }

                if (!directions.includes(selectedState.direction)) {
                    selectedState.direction = directions[0];
                }
            }


            if (selectedState.routePattern !== null && selectedState.direction !== null) {
                var routePattern = ROUTE_PATTERNS[selectedState.routePattern];
                var directions = routePattern.directions;
                var stops = routePattern.stops.slice(0);
                if (selectedState.direction == directions[1]) {
                    stops.reverse();
                }
                
                var stopNames = [];
                for (var i = 0; i < stops.length; i++) {
                    stopNames.push(stops[i].name.toUpperCase());
                }

                if (selectedState.fromStop !== null && !stopNames.includes(selectedState.fromStop)) {
                    selectedState.fromStop = stopNames[0];
                }

                if (selectedState.toStop !== null && !stopNames.includes(selectedState.toStop)) {
                    selectedState.toStop = stopNames[stopNames.length - 1];
                }

                // Reverse direction
                if (selectedState.fromStop !== null && selectedState.toStop !== null) {
                    var fromStopIndex = stopNames.indexOf(selectedState.fromStop);
                    var toStopIndex = stopNames.indexOf(selectedState.toStop);
                    if (fromStopIndex >= toStopIndex) {
                        selectedState.fromStop = stopNames[toStopIndex];
                        selectedState.toStop = stopNames[fromStopIndex];
                    }
                }
            }

            return selectedState;
        }

        function getStationsFromDOM(prefix) {
            var stations = [];
            var stationsText = document.getElementById(prefix + "-stations").value;
            var stationLines = stationsText.trim().split("\n");

            for (var i = 0; i < stationLines.length; i++) {
                var stationLine = stationLines[i];
                if (stationLine !== "") {
                    stations.push(stationLine.toUpperCase());
                }
            }

            return stations;
        }

        function updateStationAttributes(prefix) {
            // Station attributes -- update keys
            // Find stations which are in attributes but not stations array
            var attributesOnly = [];
            for (var station in state[prefix].stationAttributes) {
                if (!state[prefix].stations.includes(station)) {
                    attributesOnly.push(station);
                }
            }

            // Find stations which are in station array but not attributes
            var arrayOnly = [];
            for (var i = 0; i < state[prefix].stations.length; i++) {
                var station = state[prefix].stations[i];
                if (state[prefix].stationAttributes[station] === undefined) {
                    arrayOnly.push(station);
                }
            }

            if (attributesOnly.length > 1 || arrayOnly.length > 1) {
                // If there's more than one change, we don't know what to do, so revert to default values
                state[prefix].stationAttributes = {};
            } else {
                attributesOnly = attributesOnly[0];
                arrayOnly = arrayOnly[0];

                if ((arrayOnly !== undefined) && (attributesOnly !== undefined)) {
                    // Change
                    state[prefix].stationAttributes[arrayOnly] = copy(state[prefix].stationAttributes[attributesOnly]);
                    delete state[prefix].stationAttributes[attributesOnly];
                } else if (arrayOnly !== undefined) {
                    // Addition
                    state[prefix].stationAttributes[arrayOnly] = {};
                    for (var i = 0; i < STATION_ATTRIBUTES.length; i++) {
                        state[prefix].stationAttributes[arrayOnly][STATION_ATTRIBUTES[i]] = false;
                    }
                    state[prefix].stationAttributes[arrayOnly]["extraWidth"] = 0;
                } else if (attributesOnly !== undefined) {
                    // Deletion
                    delete state[prefix].stationAttributes[attributesOnly];
                }
            }

            if (Object.entries(state[prefix].stationAttributes) == 0) {
                // Fill default station attributes
                for (var i = 0; i < state[prefix].stations.length; i++) {
                    state[prefix].stationAttributes[state[prefix].stations[i]] = {};
                    for (var j = 0; j < STATION_ATTRIBUTES.length; j++) {
                        state[prefix].stationAttributes[state[prefix].stations[i]][STATION_ATTRIBUTES[j]] = false;
                    }
                    state[prefix].stationAttributes[state[prefix].stations[i]]["extraWidth"] = 0;
                }
            } else {
                // Station attributes -- values
                for (var i = 0; i < state[prefix].stations.length; i++) {
                    var stationPrefix = prefix + "-station-" + i.toString() + "-";
                    for (var j = 0; j < STATION_ATTRIBUTES.length; j++) {
                        var checkbox = document.getElementById(stationPrefix + STATION_ATTRIBUTES[j]);
                        if (checkbox !== null) {
                            state[prefix].stationAttributes[state[prefix].stations[i]][STATION_ATTRIBUTES[j]] = checkbox.checked;
                        }
                    }
                    var extraWidthInput = document.getElementById(stationPrefix + "extra-width");
                    if (extraWidthInput !== null) {
                        state[prefix].stationAttributes[state[prefix].stations[i]]["extraWidth"] = parseInt(extraWidthInput.value) || 0;
                    }
                }
            }
        }

        function getArrowFromDOM(prefix, direction) {
            return {
                present: document.getElementById(prefix + "-" + direction + "-arrow-present").checked,
                width: parseInt(document.getElementById(prefix + "-" + direction + "-arrow-width").value),
                text: document.getElementById(prefix + "-" + direction + "-arrow-text").value,
                color: document.getElementById(prefix + "-" + direction + "-arrow-color").value
            };
        }

        function getSegmentsFromDOM(prefix) {
            if (state[prefix].segments.length == state[prefix].segmentCount) {
                var newSegments = [];
                for (var i = 0; i < state[prefix].segments.length; i++) {
                    var segment = state[prefix].segments[i];

                    newSegments.push({
                        fromStopIndex: document.getElementById(prefix + "-segment-" + i.toString() + "-from-stop").value,
                        toStopIndex: document.getElementById(prefix + "-segment-" + i.toString() + "-to-stop").value,
                        style: document.getElementById(prefix + "-segment-" + i.toString() + "-style").value
                    });
                }

                return newSegments;
            } else if (state[prefix].segments.length > state[prefix].segmentCount) {
                var newSegments = [];
                for (var i = 0; i < state[prefix].segmentCount - 1; i++) {
                    var segment = state[prefix].segmentCount[i];
                    newSegments.push({
                        fromStopIndex: document.getElementById(prefix + "-segment-" + i.toString() + "-from-stop").value,
                        toStopIndex: document.getElementById(prefix + "-segment-" + i.toString() + "-to-stop").value,
                        style: document.getElementById(prefix + "-segment-" + i.toString() + "-style").value
                    });
                }

                // Special case last line
                newSegments.push({
                    fromStopIndex: state[prefix].segments[state[prefix].segmentCount - 1].fromStopIndex,
                    toStopIndex: state[prefix].stations.length - 1,
                    style: state[prefix].segments[state[prefix].segmentCount - 1].style,
                });

                return newSegments;
            } else if (state[prefix].segments.length < state[prefix].segmentCount) {
                var newSegments = [];
                for (var i = 0; i < state[prefix].segments.length; i++) {
                    var segment = state[prefix].segments[i];

                    newSegments.push({
                        fromStopIndex: document.getElementById(prefix + "-segment-" + i.toString() + "-from-stop").value,
                        toStopIndex: document.getElementById(prefix + "-segment-" + i.toString() + "-to-stop").value,
                        style: document.getElementById(prefix + "-segment-" + i.toString() + "-style").value
                    });
                }

                // Additional lines
                for (var i = state[prefix].segments.length; i < state[prefix].segmentCount; i++) {
                    newSegments.push({
                        fromStopIndex: state[prefix].stations.length - 1,
                        toStopIndex: state[prefix].stations.length - 1,
                        style: "shuttle"
                    });
                }

                return newSegments;
            }
        }

        function getAlignmentFromDOM(prefix) {
            var method = document.getElementById(prefix + "-alignment-select").value;

            if (method == "left") {
                var offsetElt = document.getElementById(prefix + "-alignment-offset");
                if (offsetElt === null) {
                    var offset = 0;
                } else {
                    var offset = parseInt(offsetElt.value);
                }
                return { method: method, offset: offset };
            } else {
                return { method: method };
            }
        }

        function getConnectionsFromDOM() {
            if (state.lower.connections.length >= state.lower.connectionCount) {
                var newConnections = [];
                for (var i = 0; i < state.lower.connectionCount; i++) {
                    newConnections.push({
                        upperIndex: document.getElementById("connection-" + i.toString() + "-upper-stop").value,
                        lowerIndex: document.getElementById("connection-" + i.toString() + "-lower-stop").value,
                        style: document.getElementById("connection-" + i.toString() + "-style").value
                    });
                }
            } else {
                var newConnections = [];
                for (var i = 0; i < state.lower.connections.length; i++) {
                    newConnections.push({
                        upperIndex: document.getElementById("connection-" + i.toString() + "-upper-stop").value,
                        lowerIndex: document.getElementById("connection-" + i.toString() + "-lower-stop").value,
                        style: document.getElementById("connection-" + i.toString() + "-style").value
                    });
                }

                // Add new connections in some default state
                // (0, 0) for now, but maybe add support for (null, null)
                for (var i = state.lower.connections.length; i < state.lower.connectionCount; i++) {
                    newConnections.push({ upperIndex: 0, lowerIndex: 0, style: "transfer" });
                }
            }

            return newConnections;
        }

        function getStateFromDOM() {
            state.secondLinePresent = document.getElementById("second-line-present").checked;
            state.width = parseInt(document.getElementById("width").value);
            state.downloadWidth = parseInt(document.getElementById("download-width").value);
            state.autoWidth = document.getElementById("auto-width").checked;
            state.style = getStyleFromDOM();

            state.selectedExample = document.getElementById("example").value;
            if (state.selectedExample == "null") { state.selectedExample = null; }

            state.upper.selected = getSelectedFromDOM("upper");
            
            // Stations
            state.upper.stationsText = document.getElementById("upper-stations").value;
            state.upper.stations = getStationsFromDOM("upper");
            updateStationAttributes("upper");

            // Arrows
            state.upper.leftArrow = getArrowFromDOM("upper", "left");
            state.upper.rightArrow = getArrowFromDOM("upper", "right");

            // Segments
            state.upper.segmentCount = parseInt(document.getElementById("upper-segment-count").value);
            state.upper.segments = getSegmentsFromDOM("upper");

            if (state.secondLinePresent) {
                // If we've just checked the box to add a second line, use a default state
                var testElt = document.getElementById("lower-stations");
                if (testElt === null) {
                    state.lower = copy(DEFAULT_LOWER);
                } else {
                    state.lower.selected = getSelectedFromDOM("lower");
                    
                    // Stations
                    state.lower.stationsText = document.getElementById("lower-stations").value;
                    state.lower.stations = getStationsFromDOM("lower");
                    updateStationAttributes("lower");

                    // Arrows
                    state.lower.leftArrow = getArrowFromDOM("lower", "left");
                    state.lower.rightArrow = getArrowFromDOM("lower", "right");

                    // Segments
                    state.lower.segmentCount = parseInt(document.getElementById("lower-segment-count").value);
                    state.lower.segments = getSegmentsFromDOM("lower");

                    // Alignment
                    state.lower.alignment = getAlignmentFromDOM("lower");

                    // Connections
                    state.lower.connectionCount = parseInt(document.getElementById("connection-count").value);
                    state.lower.connections = getConnectionsFromDOM();
                }
            } else {
                state.lower = {};
            }

            buildDOMFromState(state);
        }

        function getOrderedStops(state, prefix) {
            var routePattern = ROUTE_PATTERNS[state[prefix].selected.routePattern];
            var directions = routePattern.directions;
            var stops = routePattern.stops.slice(0);

            if (state[prefix].selected.direction == directions[1]) {
                stops.reverse();
            }

            return stops;
        }

        function buildTableInput(id, value, type, label) {
            var containerElt = document.createElement("tr");

            var labelElt = document.createElement("td");
            labelElt.innerHTML = label;

            var inputCellElt = document.createElement("td");
            var inputElt = document.createElement("input");
            inputElt.id = id;
            inputElt.type = type;

            if (type == "checkbox") {
                inputElt.checked = value;
            } else {
                inputElt.value = value;
            }            
            
            inputElt.onchange = function() { getStateFromDOM(); }
            containerElt.appendChild(labelElt);
            inputCellElt.appendChild(inputElt);
            containerElt.appendChild(inputCellElt);

            return containerElt;
        }

        function buildTableSelect(id, options, selectedValue, label) {
            var containerElt = document.createElement("td");
            var selectElt = document.createElement("select");
            selectElt.id = id;

            if (label !== undefined) {
                var labelElt = document.createElement("option");
                labelElt.disabled = true;
                labelElt.selected = true;
                labelElt.innerHTML = label;
                labelElt.value = null;
                selectElt.appendChild(labelElt);
            }

            for (var i = 0; i < options.length; i++) {
                var option = options[i];
                var optionElt = document.createElement("option");
                optionElt.value = option.value;
                optionElt.innerHTML = option.name;
                selectElt.appendChild(optionElt);
            }

            selectElt.onchange = function() { getStateFromDOM(); }
            selectElt.value = selectedValue;
            containerElt.appendChild(selectElt);
            return containerElt;
        }

        function buildSelect(id, options, selectedValue, label) {
            var containerElt = document.createElement("div");
            var selectElt = document.createElement("select");
            selectElt.id = id;

            if (label !== undefined) {
                var labelElt = document.createElement("option");
                labelElt.disabled = true;
                labelElt.selected = true;
                labelElt.innerHTML = label;
                labelElt.value = null;
                selectElt.appendChild(labelElt);
            }

            for (var i = 0; i < options.length; i++) {
                var option = options[i];
                var optionElt = document.createElement("option");
                optionElt.value = option.value;
                optionElt.innerHTML = option.name;
                selectElt.appendChild(optionElt);
            }

            selectElt.onchange = function() { getStateFromDOM(); }
            selectElt.value = selectedValue;
            containerElt.appendChild(selectElt);
            return containerElt;
        }

        function buildStylesFromState(state) {
            // Widths
            var container = document.getElementById("style-container");
            container.innerHTML = "";

            var table = document.createElement("table");

            var exampleOptions = [
                { name: "Green Line D (Newton Highlands - Kenmore)", value: "green-d" },
                { name: "Haymarket Closure", value: "haymarket" },
                { name: "Orange Line (Sullivan - Tufts)", value: "orange" }
            ];
            table.appendChild(
                buildTableSelect("example", exampleOptions, state.selectedExample, "-- example --")
            );

            // Load button
            var loadButton = document.createElement("input");
            loadButton.type = "submit";
            loadButton.value = "Load Example";
            loadButton.onclick = function() { loadExample(); }
            table.appendChild(loadButton);

            var blankLine = document.createElement("tr");
            blankLine.appendChild(document.createElement("br"));
            table.appendChild(blankLine);

            table.appendChild(
                buildTableInput("width", state.width, "number", "Width")
            );
            table.appendChild(
                buildTableInput("download-width", state.downloadWidth, "number", "Download width")
            );

            // Save button
            var saveButton = document.createElement("input");
            saveButton.type = "submit";
            saveButton.value = "Save Diagram";
            saveButton.onclick = function() { save(); }
            table.appendChild(saveButton);

            var blankLine = document.createElement("tr");
            blankLine.appendChild(document.createElement("br"));
            table.appendChild(blankLine);

            // Global style parameters
            for (var i = 0; i < STYLE_ATTRIBUTES.length; i++) {
                var style = STYLE_ATTRIBUTES[i];
                table.appendChild(
                    buildTableInput(style.id, state.style[style.attribute], style.type, style.label)
                );
            }

            table.appendChild(buildTableInput("auto-width", state.autoWidth, "checkbox", "Set widths automatically?"));
            table.appendChild(buildTableInput("second-line-present", state.secondLinePresent, "checkbox", "Add second line"));

            container.appendChild(table);
        }

        function buildStationsFromState(state, prefix) {
            // Stations
            var stationContainer = document.getElementById(prefix + "-station-container");
            stationContainer.innerHTML = "";

            // Route pattern picker
            var routePatternOptions = [];
            for (var routePatternID in ROUTE_PATTERNS) {
                routePatternOptions.push({
                    name: ROUTE_PATTERNS[routePatternID].name,
                    value: routePatternID
                });
            }
            var routePatternSelect = buildSelect(
                prefix + "-route-pattern",
                routePatternOptions,
                state[prefix].selected.routePattern,
                "-- route pattern --"
            );
            stationContainer.appendChild(routePatternSelect);

            // Direction picker
            var directionOptions = [];
            if (state[prefix].selected.routePattern !== null) {
                var routePattern = ROUTE_PATTERNS[state[prefix].selected.routePattern];
                for (var i = 0; i < routePattern.directions.length; i++) {
                    directionOptions.push({
                        name: routePattern.directions[i],
                        value: routePattern.directions[i]
                    });
                }
            }
            var directionSelect = buildSelect(
                prefix + "-route-direction",
                directionOptions,
                state[prefix].selected.direction,
                "-- direction --"
            );
            stationContainer.appendChild(directionSelect);

            // From stop picker
            var fromStopOptions = [];
            if (state[prefix].selected.direction !== null) {
                var stops = getOrderedStops(state, prefix);
                for (var i = 0; i < stops.length; i++) {
                    var stop = stops[i];
                    fromStopOptions.push({
                        name: stop.name.toUpperCase(),
                        value: stop.name.toUpperCase()
                    })
                }
            }
            var fromStopSelect = buildSelect(
                prefix + "-station-from-stop",
                fromStopOptions,
                state[prefix].selected.fromStop,
                "-- from stop --"
            );
            stationContainer.appendChild(fromStopSelect);

            // To stop picker
            var toStopOptions = [];
            if (state[prefix].selected.direction !== null) {
                var stops = getOrderedStops(state, prefix);
                for (var i = 0; i < stops.length; i++) {
                    var stop = stops[i];
                    toStopOptions.push({
                        name: stop.name.toUpperCase(),
                        value: stop.name.toUpperCase()
                    })
                }
            }
            var toStopSelect = buildSelect(
                prefix + "-station-to-stop",
                toStopOptions,
                state[prefix].selected.toStop,
                "-- to stop --"
            );
            stationContainer.appendChild(toStopSelect);

            // Fill stations button
            var fillStationsButton = document.createElement("input");
            fillStationsButton.type = "submit";
            fillStationsButton.value = "Fill Stations";
            fillStationsButton.onclick = function() { fillStations(prefix); }
            stationContainer.appendChild(fillStationsButton);


            stationContainer.appendChild(document.createElement("br"));


            // Stations Textarea
            var stationsTextarea = document.createElement("textarea");
            stationsTextarea.id = prefix + "-stations";
            stationsTextarea.cols = 24;
            stationsTextarea.rows = 12;
            stationsTextarea.onkeyup = function () { getStateFromDOM(); }
            stationsTextarea.value = state[prefix].stationsText;
            stationContainer.appendChild(stationsTextarea);
        }

        function buildStationGridFromState(state, prefix) {
            var container = document.getElementById(prefix + "-station-attribute-container");
            container.innerHTML = "";
            var table = document.createElement("table");

            // header row
            var rowElement = document.createElement("tr");
            var cell = document.createElement("td");
            cell.innerHTML = "station name";
            rowElement.appendChild(cell);
            for (var i = 0; i < STATION_ATTRIBUTES.length; i++) {
                var cell = document.createElement("td");
                cell.innerHTML = STATION_ATTRIBUTES[i];
                rowElement.appendChild(cell);
            }

            var cell = document.createElement("td");
            cell.innerHTML = "extra width after";
            rowElement.appendChild(cell);

            table.appendChild(rowElement);

            // input rows
            for (var i = 0; i < state[prefix].stations.length; i++) {
                var rowElement = document.createElement("tr");
                var nameCell = document.createElement("td");
                nameCell.innerHTML = state[prefix].stations[i];
                rowElement.appendChild(nameCell);

                for (var j = 0; j < STATION_ATTRIBUTES.length; j++) {
                    var cell = document.createElement("td");
                    var checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.id = prefix + "-station-" + i.toString() + "-" + STATION_ATTRIBUTES[j];
                    checkbox.checked = state[prefix].stationAttributes[state[prefix].stations[i]][STATION_ATTRIBUTES[j]];
                    checkbox.onchange = function() { getStateFromDOM(); }
                    cell.appendChild(checkbox);
                    rowElement.appendChild(cell);
                }

                var cell = document.createElement("td");
                var input = document.createElement("input");
                input.type = "number";
                input.id = prefix + "-station-" + i.toString() + "-extra-width";
                input.value = state[prefix].stationAttributes[state[prefix].stations[i]]["extraWidth"];
                input.onchange = function() { getStateFromDOM(); }
                cell.appendChild(input);
                rowElement.appendChild(cell);
                
                table.appendChild(rowElement);
            }
            container.appendChild(table);
        }

        function buildArrowsFromState(state, prefix) {
            var container = document.getElementById(prefix + "-arrow-container");
            container.innerHTML = "";

            var table = document.createElement("table");

            for (var i in ["left", "right"]) {
                var direction = ["left", "right"][i];
                var arrowState;
                if (direction == "left") {
                    arrowState = state[prefix].leftArrow;
                } else {
                    arrowState = state[prefix].rightArrow;
                }

                table.appendChild(
                    buildTableInput(prefix + "-" + direction + "-arrow-present", arrowState.present, "checkbox", direction + " arrow present?"),
                );
                table.appendChild(
                    buildTableInput(prefix + "-" + direction + "-arrow-width", arrowState.width, "number", direction + " arrow width"),
                );
                table.appendChild(
                    buildTableInput(prefix + "-" + direction + "-arrow-text", arrowState.text, "text", direction + " arrow text"),
                );

                var row = document.createElement("tr");
                var labelCell = document.createElement("td");
                var selectCell = document.createElement("td");
                labelCell.innerHTML = direction + " arrow color";
                var selectElt = buildSelect(prefix + "-" + direction + "-arrow-color", COLOR_OPTIONS, arrowState.color);
                selectCell.appendChild(selectElt);
                row.appendChild(labelCell);
                row.appendChild(selectCell);
                table.appendChild(row);
                
                container.appendChild(table);
            }
        }

        function buildSegmentsFromState(state, prefix) {
            var container = document.getElementById(prefix + "-segment-container");
            container.innerHTML = "";

            var segmentCountInput = document.createElement("label");
            segmentCountInput.innerHTML = "Number of Segments: ";

            var segmentCountElt = document.createElement("input");
            segmentCountElt.id = prefix + "-segment-count";
            segmentCountElt.value = state[prefix].segmentCount;
            segmentCountElt.type = "number";
            segmentCountElt.min = 1;
            segmentCountElt.onchange = function() { getStateFromDOM(); }

            container.appendChild(segmentCountInput);
            container.appendChild(segmentCountElt);

            container.appendChild(document.createElement("div"));

            var table = document.createElement("table");

            var stopOptions = [];
            for (var i = 0; i < state[prefix].stations.length; i++) {
                var station = state[prefix].stations[i];
                stopOptions.push({ name: station, value: i });
            }

            var styleOptions = [
                { name: "Shuttle", value: "shuttle" },
                { name: "Red Line", value: "red" },
                { name: "Orange Line", value: "orange" },
                { name: "Green Line", value: "green" },
                { name: "Blue Line", value: "blue" },
                { name: "Silver Line", value: "silver" },
                { name: "Commuter Rail", value: "purple" },
                { name: "Bus", value: "bus" },
                { name: "Disabled", value: "disabled" },
                { name: "Walk", value: "walk" }
            ];

            for (var i = 0; i < state[prefix].segments.length; i++) {
                var segment = state[prefix].segments[i];
                
                var row = document.createElement("tr");
                var fromStop = document.createElement("td");
                var fromStopID = prefix + "-segment-" + i.toString() + "-from-stop";
                var fromStopSelect = buildTableSelect(fromStopID, stopOptions, segment.fromStopIndex);
                fromStopSelect.onchange = function(event) { updateSegmentStation(state, event); };
                row.appendChild(fromStopSelect);

                var toStop = document.createElement("td");
                var toStopID = prefix + "-segment-" + i.toString() + "-to-stop";
                var toStopSelect = buildTableSelect(toStopID, stopOptions, segment.toStopIndex);
                toStopSelect.onchange = function(event) { updateSegmentStation(state, event); };
                row.appendChild(toStopSelect);

                var style = document.createElement("td");
                var styleID = prefix + "-segment-" + i.toString() + "-style";
                row.appendChild(buildTableSelect(styleID, styleOptions, segment.style));
                table.appendChild(row);
            }

            container.appendChild(table);
        }

        function buildContainersFromState(state) {
            var linesContainer = document.getElementById("lines");
            linesContainer.innerHTML = "";

            var upperLineContainer = document.createElement("div");
            upperLineContainer.style = "display: flex;";

            var containerNames = ["station", "station-attribute", "arrow", "segment"];
            for (var i = 0; i < containerNames.length; i++) {
                var name = containerNames[i];

                var containerElt = document.createElement("div");
                containerElt.id = "upper-" + name + "-container";
                containerElt.className = "container";
                upperLineContainer.appendChild(containerElt);
            }

            linesContainer.appendChild(upperLineContainer);

            if (state.secondLinePresent) {
                var lowerLineContainer = document.createElement("div");
                lowerLineContainer.style = "display: flex;";

                var containerNames = ["station", "station-attribute", "arrow", "segment", "alignment"];
                for (var i = 0; i < containerNames.length; i++) {
                    var name = containerNames[i];

                    var containerElt = document.createElement("div");
                    containerElt.id = "lower-" + name + "-container";
                    containerElt.className = "container";
                    lowerLineContainer.appendChild(containerElt);
                }

                linesContainer.appendChild(lowerLineContainer);
            }
        }

        function buildAlignmentFromState(state, prefix) {
            var container = document.getElementById(prefix + "-alignment-container");
            container.innerHTML = "";

            var alignmentOptions = [
                { name: "Left", value: "left" },
                { name: "Justify", value: "justify" }
                // TODO pin
            ];
            container.appendChild(
                buildSelect(prefix + "-alignment-select", alignmentOptions, state[prefix].alignment.method)
            );

            if (state[prefix].alignment.method == "left") {
                var offsetContainer = document.createElement("div");

                var offsetInput = document.createElement("label");
                offsetInput.innerHTML = "Offset by # stations: ";

                var offsetElt = document.createElement("input");
                offsetElt.id = prefix + "-alignment-offset";
                offsetElt.value = state[prefix].alignment.offset;
                offsetElt.type = "number";
                offsetElt.onchange = function() { getStateFromDOM(); }

                offsetContainer.appendChild(offsetInput);
                offsetContainer.appendChild(offsetElt);
                container.appendChild(offsetContainer);
            }

            container.appendChild(document.createElement("br"));

            var connectionCountLabel = document.createElement("label");
            connectionCountLabel.innerHTML = "Number of Connections: ";

            var connectionCountInput = document.createElement("input");
            connectionCountInput.id = "connection-count";
            connectionCountInput.value = state.lower.connectionCount;
            connectionCountInput.type = "number";
            connectionCountInput.min = 0;
            connectionCountInput.onchange = function() { getStateFromDOM(); }

            container.appendChild(connectionCountLabel);
            container.appendChild(connectionCountInput);

            container.appendChild(document.createElement("br"));

            var connectionTable = document.createElement("table");

            var upperStopOptions = [];
            for (var i = 0; i < state.upper.stations.length; i++) {
                var station = state.upper.stations[i];
                upperStopOptions.push({ name: station, value: i });
            }

            var lowerStopOptions = [];
            for (var i = 0; i < state.lower.stations.length; i++) {
                var station = state.lower.stations[i];
                lowerStopOptions.push({ name: station, value: i });
            }

            var styleOptions = [
                { name: "Transfer", value: "transfer" },
                { name: "Walk", value: "walk" },
                { name: "Shuttle", value: "shuttle" }
            ];

            for (var i = 0; i < state.lower.connections.length; i++) {
                var connection = state.lower.connections[i];
                var row = document.createElement("tr");

                var upperStop = document.createElement("td");
                var upperStopID = "connection-" + i.toString() + "-upper-stop";
                var upperStopSelect = buildTableSelect(upperStopID, upperStopOptions, connection.upperIndex);
                row.appendChild(upperStopSelect);

                var lowerStop = document.createElement("td");
                var lowerStopID = "connection-" + i.toString() + "-lower-stop";
                var lowerStopSelect = buildTableSelect(lowerStopID, lowerStopOptions, connection.lowerIndex);
                row.appendChild(lowerStopSelect);

                var style = document.createElement("td");
                var styleID = "connection-" + i.toString() + "-style";
                row.appendChild(buildTableSelect(styleID, styleOptions, connection.style));

                connectionTable.appendChild(row);
            }

            container.appendChild(connectionTable);
        }

        function buildDOMFromState(state) {
            // Save focus so it can be restored later
            var activeId = document.activeElement.id;
            var activePos = document.activeElement.selectionStart;

            // Build UI
            buildContainersFromState(state);
            buildStylesFromState(state);
            

            buildStationsFromState(state, "upper");
            buildStationGridFromState(state, "upper");
            buildArrowsFromState(state, "upper");
            buildSegmentsFromState(state, "upper");

            if (state.secondLinePresent) {
                buildStationsFromState(state, "lower");
                buildStationGridFromState(state, "lower");
                buildArrowsFromState(state, "lower");
                buildSegmentsFromState(state, "lower");
                buildAlignmentFromState(state, "lower");
            }

            // Restore focus
            var activeElement = document.getElementById(activeId);
            if (activeElement) {
                activeElement.focus();
                try {
                    activeElement.setSelectionRange(activePos, activePos);
                } catch (error) {
                    // Do nothing
                }
            }

            // Update diagram
            var params = extractParamsFromState(state);
            draw(params);
        }

        function fillStations(prefix) {
            var direction = state[prefix].selected.direction;
            var routePattern = ROUTE_PATTERNS[state[prefix].selected.routePattern];
            var directions = routePattern.directions;
            var stops = getOrderedStops(state, prefix);

            var foundFromStop = false;
            var foundToStop = false;
            var includesFirstStop = false;
            var includesLastStop = false;
            var leftArrowText;
            var rightArrowText;

            var stations = [];
            for (var i = 0; i < stops.length; i++) {
                var stop = stops[i];

                if (stop.name.toUpperCase() == state[prefix].selected.fromStop) {
                    foundFromStop = true;
                    leftArrowText = (direction == directions[0]) ? stop.destinations[1] : stop.destinations[0];
                }

                if (foundFromStop && !foundToStop) {
                    stations.push(stop.name.toUpperCase());

                    if (i == 0) {
                        includesFirstStop = true;
                    }

                    if (i == stops.length - 1) {
                        includesLastStop = true;
                    }
                }

                if (stop.name.toUpperCase() == state[prefix].selected.toStop) {
                    foundToStop = true;
                    rightArrowText = (direction == directions[0]) ? stop.destinations[0] : stop.destinations[1];
                }
            }

            document.getElementById(prefix + "-stations").value = stations.join("\n");
            document.getElementById(prefix + "-left-arrow-color").value = routePattern.color;
            document.getElementById(prefix + "-right-arrow-color").value = routePattern.color;

            if (includesFirstStop) {
                document.getElementById(prefix + "-left-arrow-present").checked = false;
            } else {
                document.getElementById(prefix + "-left-arrow-present").checked = true;
                document.getElementById(prefix + "-left-arrow-text").value = leftArrowText;
            }

            if (includesLastStop) {
                document.getElementById(prefix + "-right-arrow-present").checked = false;
            } else {
                document.getElementById(prefix + "-right-arrow-present").checked = true;
                document.getElementById(prefix + "-right-arrow-text").value = rightArrowText;
            }
            
            // Hack to make sure that stations.length - 1 is a valid option
            var selectElt = document.getElementById(prefix + "-segment-0-to-stop");
            var newOption = document.createElement("option");
            newOption.value = stations.length - 1;
            selectElt.appendChild(newOption);

            document.getElementById(prefix + "-segment-count").value = 1;
            document.getElementById(prefix + "-segment-0-from-stop").value = 0;
            document.getElementById(prefix + "-segment-0-to-stop").value = stations.length - 1;
            document.getElementById(prefix + "-segment-0-style").value = "shuttle";

            // Enable auto width
            document.getElementById("auto-width").checked = true;

            getStateFromDOM();
        }

        function updateSegmentStation(state, event) {
            // If updating a to-stop, also update the next from-stop
            if (event !== undefined && event.target.id.includes("to-stop")) {
                var prefix = event.target.id.split("-")[0];
                var idx = parseInt(event.target.id.split("-")[2]);
                if (idx < state[prefix].segmentCount - 1) {
                    var nextElt = document.getElementById(prefix + "-segment-" + (idx + 1).toString() + "-from-stop");
                    nextElt.value = event.target.value;
                }
            }

            // If updating a from-stop, also update the previous to-stop
            if (event !== undefined && event.target.id.includes("from-stop")) {
                var prefix = event.target.id.split("-")[0];
                var idx = parseInt(event.target.id.split("-")[2]);
                if (idx > 0) {
                    var prevElt = document.getElementById(prefix + "-segment-" + (idx - 1).toString() + "-to-stop");
                    prevElt.value = event.target.value;
                }
            }

            getStateFromDOM();
        }

        function parseColor(color) {
            if (color == "green") { return "#00843D"; }
            if (color == "orange") { return "#ED8B00"; }
            if (color == "red") { return "#DA291C"; }
            if (color == "blue") { return "#003DA5"; }
            if (color == "purple") { return "#80276C"; }
            if (color == "silver") { return "#7C878E"; }
            if (color == "bus") { return "#FFC72C"; }

            return "black";
        }

        function parseTextColor(color) {
            if (color == "bus") { return "black" ; }
            return "white";
        }

        function extractSegmentsFromState(state, prefix) {
            var segments = [];
            for (var i = 0; i < state[prefix].segments.length; i++) {
                var segment = state[prefix].segments[i];

                var newSegment = [];
                newSegment.fromStopIndex = parseInt(segment.fromStopIndex);
                newSegment.toStopIndex = parseInt(segment.toStopIndex);
                newSegment.style = segment.style;

                if (segment.style == "shuttle") {
                    newSegment.color = "black";
                    newSegment.width = state.style.lineStroke;
                    newSegment.dasharray = state.style.lineDasharray;
                } else if (segment.style == "disabled") {
                    newSegment.color = "#D2D2D2";
                    newSegment.width = state.style.stationRadius * 2;
                } else if (segment.style == "walk") {
                    newSegment.color = "black";
                    newSegment.width = state.style.lineStroke / 2;
                    newSegment.dasharray = "20, 20";
                    newSegment.linecap = "round";
                } else {
                    newSegment.color = parseColor(segment.style);
                    newSegment.width = state.style.stationRadius * 2;
                }
                segments.push(newSegment);
            }

            return segments;
        }

        function extractParamsFromState(state) {
            if (state.secondLinePresent) {
                var lower = {
                    alignment: state.lower.alignment,
                    stations: state.lower.stations,
                    stationAttributes: state.lower.stationAttributes,
                    arrows: {
                        left: {
                            present: state.lower.leftArrow.present,
                            width: state.lower.leftArrow.width,
                            text: state.lower.leftArrow.text,
                            color: parseColor(state.lower.leftArrow.color),
                            textColor: parseTextColor(state.lower.leftArrow.color)
                        },
                        right: {
                            present: state.lower.rightArrow.present,
                            width: state.lower.rightArrow.width,
                            text: state.lower.rightArrow.text,
                            color: parseColor(state.lower.rightArrow.color),
                            textColor: parseTextColor(state.lower.rightArrow.color)
                        }
                    },
                    segmentCount: state.lower.segmentCount,
                    segments: extractSegmentsFromState(state, "lower"),
                    connections: state.lower.connections
                }
            } else {
                var lower = {};
            }

            return {
                width: state.width,
                autoWidth: state.autoWidth,
                secondLinePresent: state.secondLinePresent,
                style: state.style,
                upper: {
                    stations: state.upper.stations,
                    stationAttributes: state.upper.stationAttributes,
                    arrows: {
                        left: {
                            present: state.upper.leftArrow.present,
                            width: state.upper.leftArrow.width,
                            text: state.upper.leftArrow.text,
                            color: parseColor(state.upper.leftArrow.color),
                            textColor: parseTextColor(state.upper.leftArrow.color)
                        },
                        right: {
                            present: state.upper.rightArrow.present,
                            width: state.upper.rightArrow.width,
                            text: state.upper.rightArrow.text,
                            color: parseColor(state.upper.rightArrow.color),
                            textColor: parseTextColor(state.upper.rightArrow.color)
                        }
                    },
                    segmentCount: state.upper.segmentCount,
                    segments: extractSegmentsFromState(state, "upper")
                },
                lower: lower
            };
        }

        function drawArrowText(diagram, arrow, style) {
            var arrowTextLines = arrow.text.split("//");
            return diagram
                .text(function(add) {
                    for (var i = 0; i < arrowTextLines.length; i++) {
                        add.tspan(arrowTextLines[i]).newLine();
                    }
                })
                .stroke("none")
                .fill(arrow.textColor)
                .font({
                    weight: "bold",
                    size: style.arrowTextSize + "px",
                    family: "sans-serif",
                    anchor: "middle"
                });
        }

        function drawSegments(group, segments, stationPositions) {
            for (var i = 0; i < segments.length; i++) {
                var segment = segments[i];

                var x1 = stationPositions[segment.fromStopIndex];
                var x2 = stationPositions[segment.toStopIndex];
                var lineStroke = { color: segment.color, width: segment.width };
                if (segment.dasharray) { lineStroke.dasharray = segment.dasharray; }
                if (segment.linecap) { lineStroke.linecap = segment.linecap; }

                group.line(x1, 0, x2, 0).stroke(lineStroke);
            }
        }

        function drawOctagonStation(group, centerX, centerY, idx, segments, style) {
            var currentSegment;
            for (var j = 0; j < segments.length; j++) {
                var segment = segments[j];

                if (segment.fromStopIndex <= idx && segment.toStopIndex > idx) {
                    currentSegment = segments[j];
                }
            }

            var r = style.stationRadius - style.stationStroke / 2;
            if (currentSegment !== undefined && !(["shuttle", "walk"].includes(currentSegment.style))){
                var r2 = style.stationRadius + style.stationStroke / 4;
                var octagonStroke = { color: "white", width: style.stationStroke / 2 };
            } else {
                var r2 = r;
                var octagonStroke = { color: "red", width: style.stationStroke };
            }

            var side = 2 * r2 / (1 + RT2);
            var points = [
                [(side / 2 * (1 + RT2)), (side / 2)],
                [(side / 2), (side / 2 * (1 + RT2))],
                [(-side / 2), (side / 2 * (1 + RT2))],
                [(-side / 2 * (1 + RT2)), (side / 2)],
                [(-side / 2 * (1 + RT2)), (-side / 2)],
                [(-side / 2), (-side / 2 * (1 + RT2))],
                [(side / 2), (-side / 2 * (1 + RT2))],
                [(side / 2 * (1 + RT2)), (-side / 2)],
            ];

            group.polygon(points.join(" "))
                 .move(centerX - r2, centerY - r2)
                 .fill("red")
                 .stroke(octagonStroke);

            group.line(-r/2, -r/2, r/2, r/2)
                 .move(centerX - r/2, centerY - r/2)
                 .stroke({ color: "white", width: style.stationRadius / 3 });

            group.line(-r/2, r/2, r/2, -r/2)
                 .move(centerX - r/2, centerY - r/2)
                 .stroke({ color: "white", width: style.stationRadius / 3 });
        }

        function drawCircleStation(group, centerX, centerY, idx, segments, style) {
            for (var j = 0; j < segments.length; j++) {
                var segment = segments[j];

                if (idx > segment.fromStopIndex && idx <= segment.toStopIndex) {
                    var stopStrokeColor = segment.color;

                    if (["shuttle", "walk", "disabled"].includes(segment.style) && j < segments.length - 1 && idx == segment.toStopIndex) {
                        stopStrokeColor = segments[j + 1].color;
                    }
                }

                if (idx == 0 && segment.fromStopIndex == 0) {
                    stopStrokeColor = segment.color;
                }
            }
            var r = style.stationRadius - style.stationStroke / 2;
            group.circle(2 * r)
                 .move(centerX - r, centerY - r)
                 .fill("white")
                 .stroke({ color: stopStrokeColor, width: style.stationStroke });
        }

        function drawStationLabel(group, centerX, station, style, textAnchor) {
            return group
                .text(function(add) {
                    add.tspan(station).newLine();
                })
                .rotate(STATION_TEXT_ANGLE, centerX - style.stationTextSize / 2, 0)
                .move(centerX - style.stationTextSize / 2, 0)
                .font({
                    family: "sans-serif",
                    weight: "bold",
                    size: style.stationTextSize + "px",
                    "text-anchor": textAnchor || "start"
                });

        }

        function drawStations(stationGroup, textGroup, stations, stationAttributes, segments, style, stationPositions, isaSymbol, textAnchor) {
            for (var i = 0; i < stations.length; i++) {
                var station = stations[i];

                var centerX = stationPositions[i];
                var centerY = 0;

                if (stationAttributes[station].skipped) {
                    drawOctagonStation(stationGroup, centerX, centerY, i, segments, style);
                } else {
                    drawCircleStation(stationGroup, centerX, centerY, i, segments, style);
                }

                var text = drawStationLabel(textGroup, centerX, station, style, textAnchor);
                if (stationAttributes[station].accessible) {
                    // TODO: Improve ISA Symbol positioning logic
                    if (textAnchor == "end") {
                        var isaX = centerX - style.stationTextSize / 2
                            - (text.length() + style.stationTextSize) * Math.cos(STATION_TEXT_ANGLE * Math.PI / 180);
                        var isaY = -(text.length() + 3 * style.stationTextSize / 2) * Math.sin(STATION_TEXT_ANGLE * Math.PI / 180);
                    } else {
                        var isaX = centerX - style.stationTextSize / 2
                            + (text.length() + style.stationTextSize / 4) * Math.cos(STATION_TEXT_ANGLE * Math.PI / 180);
                        var isaY = (text.length() + style.stationTextSize / 4) * Math.sin(STATION_TEXT_ANGLE * Math.PI / 180);
                    }
                    textGroup.use(isaSymbol)
                             .rotate(STATION_TEXT_ANGLE, isaX, isaY)
                             .move(isaX, isaY);
                }
            }
        }

        // ISA Symbol from Wikipedia
        function drawISASymbol(diagram, style) {
            var isaSymbol = diagram.symbol();
            isaSymbol.path("M161.9882813,98.1240234 c24.9628906-2.3046875,44.3574219-23.8110352,44.3574219-48.9658203C206.3457031,22.0830078,184.2626953,0,157.1875,0 s-49.1572266,22.0830078-49.1572266,49.1582031c0,8.2568359,2.3037109,16.7055664,6.1445313,23.8105469l17.515625,246.4667969 l180.3964844,0.0488281l73.9912109,173.3652344l97.1445313-38.0976563l-15.0429688-35.8203125l-54.3662109,19.625 l-71.5908203-165.2802734l-167.7294922,1.1269531l-2.3027344-31.2128906l121.4228516,0.0483398v-46.1831055l-126.0546875-0.0493164 L161.9882813,98.1240234z").fill("black");
            isaSymbol.path("M343.4199219,451.5908203 c-30.4472656,60.1875-94.1748047,99.8398438-162.1503906,99.8398438C81.4296875,551.4306641,0,470.0009766,0,370.1611328 c0-70.1005859,42.4853516-135.2436523,105.8818359-164.1210938l4.1025391,53.5375977 c-37.4970703,23.628418-60.6123047,66.262207-60.6123047,110.9506836c0,72.4267578,59.0712891,131.4970703,131.4970703,131.4970703 c66.2617188,0,122.7646484-50.8515625,130.4697266-116.0869141L343.4199219,451.5908203z").fill("black");
            isaSymbol.viewbox(0, 0, 483.2226563, 551.4306641);
            isaSymbol.size(style.stationTextSize, style.stationTextSize);

            return isaSymbol;
        }

        function drawWalkSymbol(diagram) {
            var walkSymbol = diagram.symbol();
            var path = walkSymbol.path("M108.08,185.45a1.52,1.52,0,0,0,.63,2l4.75,2.52a1.51,1.51,0,0,0,2-.59l11.5-20.3c.39-.7,1-1.85,1.38-2.57l7.49-14.57a.86.86,0,0,1,1.56-.15l10.06,13a5.46,5.46,0,0,1,1,2.61l1.17,23.19a1.56,1.56,0,0,0,1.53,1.46h5.09a1.46,1.46,0,0,0,1.46-1.46V164.24a5.77,5.77,0,0,0-.8-2.69l-9.9-15a3.92,3.92,0,0,1-.47-2.64l3.86-16.67a.93.93,0,0,1,1.54-.6l5.43,3.73a14.59,14.59,0,0,0,2.57,1.34l13.51,5.15a1.65,1.65,0,0,0,2-.79l1.65-3.34a1.5,1.5,0,0,0-.66-2L161.56,123a5.25,5.25,0,0,1-2-2L155,111.87a21.81,21.81,0,0,0-1.54-2.48l-1.28-1.72a5.62,5.62,0,0,0-2.26-1.65l-4.57-1.61a6.9,6.9,0,0,0-2.82-.27l-5.29.77a8.94,8.94,0,0,0-2.71,1l-14.26,8.47a4.51,4.51,0,0,0-1.71,2.14L113.09,133a1.54,1.54,0,0,0,.91,1.9l3.73,1.38a1.44,1.44,0,0,0,1.86-.86l4.28-11.91a3.56,3.56,0,0,1,1.87-1.87l7-2.55c.75-.28,1.12.11.81.85l-7.47,18.25c-.31.74-.75,2-1,2.75l-7.3,24.56a19.82,19.82,0,0,1-1.07,2.71Z");
            path.transform({x: -107.92, y: -88.24});
            var path = walkSymbol.path("M158.66,95.79a7.56,7.56,0,1,0-7.56,7.56,7.56,7.56,0,0,0,7.56-7.56");
            path.transform({x: -107.92, y: -88.24});

            walkSymbol.viewbox(0, 0, 69.31, 103.79);

            return walkSymbol;
        }

        function drawArrow(group, centerX, centerY, arrow, textElt, style, reflect, startEndX) {
            var dy = style.stationRadius - style.stationStroke / 2;

            if (reflect) {
                var points = [
                    [startEndX + style.stationRadius - style.stationStroke / RT2, centerY],
                    [startEndX, centerY + dy],
                    [startEndX - arrow.width, centerY + dy],
                    [startEndX - arrow.width, centerY - dy],
                    [startEndX, (centerY - dy)]
                ];
            } else {
                var points = [
                    [startEndX - style.stationRadius + style.stationStroke / RT2, centerY],
                    [startEndX, centerY + dy],
                    [startEndX + arrow.width, centerY + dy],
                    [startEndX + arrow.width, centerY - dy],
                    [startEndX, (centerY - dy)]
                ];
            }

            group.polygon(points.join(" "))
                 .fill(arrow.color)
                 .stroke({color: arrow.color, width: style.stationStroke});

            var r = style.stationRadius - style.stationStroke / 2;                
            group.circle(2 * r)
                 .move(centerX - r, centerY - r)
                 .fill("white")
                 .stroke({ color: arrow.color, width: style.stationStroke });

            group.add(textElt);

            if (reflect) {
                var arrowTextX = startEndX - textElt.bbox().w / 2;
            } else {
                var arrowTextX = startEndX + textElt.bbox().w / 2;
            }
            
            var arrowTextY = centerY - textElt.bbox().h / 2;
            textElt.move(arrowTextX, arrowTextY);
        }

        function calculateStationPositions(params) {
            var stationPositions = {};

            if (params.secondLinePresent) {
                var lowerStationPositions = {};

                if (params.lower.alignment.method == "left") {
                    if (params.lower.alignment.offset < 0) {
                        var startStationIndexUpper = -params.lower.alignment.offset;
                        var startStationIndexLower = 0;
                    } else {
                        var startStationIndexUpper = 0;
                        var startStationIndexLower = params.lower.alignment.offset;
                    }

                    var endStationIndexUpper = startStationIndexUpper + params.upper.stations.length - 1;
                    var endStationIndexLower = startStationIndexLower + params.lower.stations.length - 1;
                    var maxEndStationIndex = Math.max(endStationIndexUpper, endStationIndexLower);

                    // Number of stations from the left which lower starts (relative to upper)
                    var leftOffset = params.lower.alignment.offset;

                    // Number of stations from the right which lower ends (relative to upper)
                    var rightOffset = endStationIndexLower - endStationIndexUpper;

                    // Get arrow lengths
                    var upperLeftArrowWidth = params.style.stationRadius;
                    if (params.upper.arrows.left.present) { upperLeftArrowWidth += params.upper.arrows.left.width; }

                    var lowerLeftArrowWidth = params.style.stationRadius;
                    if (params.lower.arrows.left.present) { lowerLeftArrowWidth += params.lower.arrows.left.width; }

                    var upperRightArrowWidth = params.style.stationRadius;
                    if (params.upper.arrows.right.present) { upperRightArrowWidth += params.upper.arrows.right.width; }

                    var lowerRightArrowWidth = params.style.stationRadius;
                    if (params.lower.arrows.right.present) { lowerRightArrowWidth += params.lower.arrows.right.width; }

                    // Set stationDX
                    var stationCount;
                    var leftWidth;
                    var rightWidth;
                    var stationDX;

                    while (true) {
                        // Upper left, upper right
                        stationCount = endStationIndexUpper - startStationIndexUpper;
                        leftWidth = upperLeftArrowWidth;
                        rightWidth = upperRightArrowWidth;
                        stationDX = (params.width - (leftWidth + rightWidth)) / stationCount;

                        if ((upperLeftArrowWidth >= lowerLeftArrowWidth - (leftOffset * stationDX)) && (upperRightArrowWidth >= lowerRightArrowWidth + (rightOffset * stationDX))) {
                            break;
                        }

                        // Upper left, lower right
                        stationCount = endStationIndexLower - startStationIndexUpper;
                        leftWidth = upperLeftArrowWidth;
                        rightWidth = lowerRightArrowWidth;
                        stationDX = (params.width - (leftWidth + rightWidth)) / stationCount;
                        if ((upperLeftArrowWidth >= lowerLeftArrowWidth - (leftOffset * stationDX)) && (lowerRightArrowWidth + (rightOffset * stationDX) >= upperRightArrowWidth)) {
                            break;
                        }

                        // Lower left, upper right
                        stationCount = endStationIndexUpper - startStationIndexLower;
                        leftWidth = lowerLeftArrowWidth;
                        rightWidth = upperRightArrowWidth;
                        stationDX = (params.width - (leftWidth + rightWidth)) / stationCount;
                        if ((lowerLeftArrowWidth - (leftOffset * stationDX) >= upperLeftArrowWidth) && (upperRightArrowWidth >= lowerRightArrowWidth + (rightOffset * stationDX))) {
                            break;
                        }

                        // Lower left, lower right
                        stationCount = endStationIndexLower - startStationIndexLower;
                        leftWidth = lowerLeftArrowWidth;
                        rightWidth = lowerRightArrowWidth;
                        stationDX = (params.width - (leftWidth + rightWidth)) / stationCount;
                        break;
                    }

                    var startX = leftWidth + startStationIndexUpper * stationDX;
                    var lowerStartX = leftWidth + startStationIndexLower * stationDX;
                    var endX = leftWidth + endStationIndexUpper * stationDX;
                    var lowerEndX = leftWidth + endStationIndexLower * stationDX;

                    for (var i = 0; i < params.upper.stations.length; i++) {
                        stationPositions[i] = startX + i * stationDX;
                    }

                    for (var i = 0; i < params.lower.stations.length; i++) {
                        lowerStationPositions[i] = lowerStartX + i * stationDX;
                    }

                    return {
                        upper: stationPositions,
                        lower: lowerStationPositions
                    };
                } else if (params.lower.alignment.method == "justify") {
                    // Get arrow lengths
                    var upperLeftArrowWidth = params.style.stationRadius;
                    if (params.upper.arrows.left.present) { upperLeftArrowWidth += params.upper.arrows.left.width; }

                    var lowerLeftArrowWidth = params.style.stationRadius;
                    if (params.lower.arrows.left.present) { lowerLeftArrowWidth += params.lower.arrows.left.width; }

                    var upperRightArrowWidth = params.style.stationRadius;
                    if (params.upper.arrows.right.present) { upperRightArrowWidth += params.upper.arrows.right.width; }

                    var lowerRightArrowWidth = params.style.stationRadius;
                    if (params.lower.arrows.right.present) { lowerRightArrowWidth += params.lower.arrows.right.width; }

                    var upperWidth = params.width - (upperLeftArrowWidth + upperRightArrowWidth);
                    var lowerWidth = params.width - (lowerLeftArrowWidth + lowerRightArrowWidth);

                    for (var i = 0; i < params.upper.stations.length; i++) {
                        stationPositions[i] = upperLeftArrowWidth + i * upperWidth / (params.upper.stations.length - 1);
                    }

                    for (var i = 0; i < params.lower.stations.length; i++) {
                        lowerStationPositions[i] = lowerLeftArrowWidth + i * lowerWidth / (params.lower.stations.length - 1);
                    }

                    return {
                        upper: stationPositions,
                        lower: lowerStationPositions
                    };
                }
            } else {
                var upperLeftArrowWidth = params.style.stationRadius;
                if (params.upper.arrows.left.present) { upperLeftArrowWidth += params.upper.arrows.left.width; }

                var upperRightArrowWidth = params.style.stationRadius;
                if (params.upper.arrows.right.present) { upperRightArrowWidth += params.upper.arrows.right.width; }

                var stationCount = params.upper.stations.length;

                var startX = params.style.stationRadius;
                if (params.upper.arrows.left.present) { startX += params.upper.arrows.left.width; }

                var endX = params.width - params.style.stationRadius;
                if (params.upper.arrows.right.present) { endX -= params.upper.arrows.right.width; }

                var stationDX = 0;
                if (params.upper.stations.length > 1) {
                    stationDX = (endX - startX) / (stationCount - 1);
                }

                for (var i = 0; i < params.upper.stations.length; i++) {
                    stationPositions[i] = startX + i * stationDX;
                }

                return { upper: stationPositions };
            }
        }

        function adjustForExtraWidth(stationPositions, lineParams) {
            var totalExtraWidth = 0;
            for (var i = 0; i < lineParams.stations.length; i++) {
                var station = lineParams.stations[i];
                var extraWidth = lineParams.stationAttributes[station].extraWidth;
                totalExtraWidth += extraWidth;
            }

            var gaps = [];
            var totalGap = 0;
            for (var i = 1; i < lineParams.stations.length; i++) {
                var gap = stationPositions[i] - stationPositions[i - 1];
                gaps.push(gap);
                totalGap += gap;

            }

            var scale = (totalGap - totalExtraWidth) / totalGap;
            for (var i = 0; i < gaps.length; i++) {
                var station = lineParams.stations[i];
                var extraWidth = lineParams.stationAttributes[station].extraWidth;

                gaps[i] *= scale;
                gaps[i] += extraWidth;
            }

            var newStationPositions = { 0: stationPositions[0] };
            for (var i = 0; i < gaps.length; i++) {
                newStationPositions[i + 1] = newStationPositions[i] + gaps[i];
            }

            return newStationPositions;
        }

        function draw(params) {
            // Clear existing diagram
            document.getElementById("drawing").innerHTML = "";

            // Create SVG
            var diagram = SVG('drawing')
                .size(params.width, 100)
                .style({
                    "background-color": "white",
                    "outline": "1px solid black"
                });

            // Put everything inside container so it can be moved later to add padding
            var container = diagram.group();

            // Create groups in the right order
            if (params.secondLinePresent) {
                var connectionGroupBack = container.group();
            }
            var textGroup = container.group();
            var lineGroup = container.group();
            var stationGroup = container.group();
            if (params.upper.arrows.left.present) { var leftArrowGroup = container.group(); }
            if (params.upper.arrows.right.present) { var rightArrowGroup = container.group(); }

            if (params.secondLinePresent) {
                var lowerTextGroup = container.group();
                var lowerLineGroup = container.group();
                var lowerStationGroup = container.group();
                if (params.lower.arrows.left.present) { var lowerLeftArrowGroup = container.group(); }
                if (params.lower.arrows.right.present) { var lowerRightArrowGroup = container.group(); }
                var connectionGroup = container.group();
            }

            var isaSymbol = drawISASymbol(diagram, params.style);
            var walkSymbol = drawWalkSymbol(diagram);

            // Arrow text
            if (params.upper.arrows.left.present) {
                var leftArrowTextElt = drawArrowText(diagram, params.upper.arrows.left, params.style);
            }

            if (params.upper.arrows.right.present) {
                var rightArrowTextElt = drawArrowText(diagram, params.upper.arrows.right, params.style);
            }

            if (params.secondLinePresent && params.lower.arrows.left.present) {
                var lowerLeftArrowTextElt = drawArrowText(diagram, params.lower.arrows.left, params.style);
            }

            if (params.secondLinePresent && params.lower.arrows.right.present) {
                var lowerRightArrowTextElt = drawArrowText(diagram, params.lower.arrows.right, params.style);
            }

            if (params.autoWidth) {
                // Compute new widths
                if (params.upper.arrows.left.present) {
                    var upperLeftWidth = Math.round(leftArrowTextElt.bbox().w + params.style.stationRadius * 2);
                    if (params.secondLinePresent && params.lower.arrows.left.present) {
                        var lowerLeftWidth = Math.round(lowerLeftArrowTextElt.bbox().w + params.style.stationRadius * 2);
                    } else {
                        var lowerLeftWidth = 0;
                    }

                    var leftWidth = Math.max(upperLeftWidth, lowerLeftWidth);

                    params.upper.arrows.left.width = leftWidth;
                    document.getElementById("upper-left-arrow-width").value = leftWidth;

                    if (params.secondLinePresent && params.lower.arrows.left.present) {
                        params.lower.arrows.left.width = leftWidth;
                        document.getElementById("lower-left-arrow-width").value = leftWidth;
                    }
                }

                if (params.upper.arrows.right.present) {
                    var upperRightWidth = Math.round(rightArrowTextElt.bbox().w + params.style.stationRadius * 2);
                    if (params.secondLinePresent && params.lower.arrows.right.present) {
                        var lowerRightWidth = Math.round(lowerRightArrowTextElt.bbox().w + params.style.stationRadius * 2);
                    } else {
                        var lowerRightWidth = 0;
                    }

                    var rightWidth = Math.max(upperRightWidth, lowerRightWidth);

                    params.upper.arrows.right.width = rightWidth;
                    document.getElementById("upper-right-arrow-width").value = rightWidth;

                    if (params.secondLinePresent && params.lower.arrows.right.present) {
                        params.lower.arrows.right.width = rightWidth;
                        document.getElementById("lower-right-arrow-width").value = rightWidth;
                    }
                }
            }

            // Calculate station positions
            var positions = calculateStationPositions(params);
            var stationPositions = positions.upper;
            if (params.secondLinePresent) {
                var lowerStationPositions = positions.lower;
            }

            // Adjust for extra width
            stationPositions = adjustForExtraWidth(stationPositions, params.upper);
            if (params.secondLinePresent) {
                lowerStationPositions = adjustForExtraWidth(lowerStationPositions, params.lower);
            }


            ////////////////////////////////////////////////////////////////////////////////

            // Draw segments
            drawSegments(lineGroup, params.upper.segments, stationPositions);

            if (params.secondLinePresent) {
                drawSegments(lowerLineGroup, params.lower.segments, lowerStationPositions);
            }

            // Draw stations
            drawStations(
                stationGroup,
                textGroup,
                params.upper.stations,
                params.upper.stationAttributes,
                params.upper.segments,
                params.style,
                stationPositions,
                isaSymbol
            );

            if (params.secondLinePresent) {
                drawStations(
                    lowerStationGroup,
                    lowerTextGroup,
                    params.lower.stations,
                    params.lower.stationAttributes,
                    params.lower.segments,
                    params.style,
                    lowerStationPositions,
                    isaSymbol,
                    "end"
                );
            }

            // Use measured element heights to set Y coordinates of groups
            var measuredTextHeight = textGroup.bbox().h;
            var measuredLineHeight = stationGroup.bbox().h;
            var lineY = measuredTextHeight + measuredLineHeight / 2 + params.style.lineExtraSpace;

            lineGroup.move(0, lineY);
            stationGroup.move(0, lineY);
            textGroup.move(0, measuredTextHeight - params.style.stationTextSize);

            if (params.secondLinePresent) {
                var lowerLineY = lineY + params.style.stationRadius * 5;
                lowerLineGroup.move(0, lowerLineY);
                lowerStationGroup.move(0, lowerLineY);
                lowerTextGroup.move(0, lowerLineY + params.style.stationTextSize);
            }

            // Draw arrows
            if (params.upper.arrows.left.present) {
                drawArrow(leftArrowGroup, stationPositions[0], lineY, params.upper.arrows.left, leftArrowTextElt, params.style, false, stationPositions[0] - params.upper.arrows.left.width);
            }
            
            if (params.secondLinePresent && params.lower.arrows.left.present) {
                drawArrow(lowerLeftArrowGroup, lowerStationPositions[0], lowerLineY, params.lower.arrows.left, lowerLeftArrowTextElt, params.style, false, lowerStationPositions[0] - params.lower.arrows.left.width);
            }

            if (params.upper.arrows.right.present) {
                drawArrow(rightArrowGroup, stationPositions[params.upper.stations.length - 1], lineY, params.upper.arrows.right, rightArrowTextElt, params.style, true, stationPositions[params.upper.stations.length - 1] + params.upper.arrows.right.width);
            }
            
            if (params.secondLinePresent && params.lower.arrows.right.present) {
                drawArrow(lowerRightArrowGroup, lowerStationPositions[params.lower.stations.length - 1], lowerLineY, params.lower.arrows.right, lowerRightArrowTextElt, params.style, true, lowerStationPositions[params.lower.stations.length - 1] + params.lower.arrows.right.width);
            }

            // Draw connections
            if (params.secondLinePresent) {
                for (var i = 0; i < params.lower.connections.length; i++) {
                    var connection = params.lower.connections[i];
                    
                    var r = params.style.stationRadius - params.style.stationStroke / 2;
                    var centerX1 = stationPositions[connection.upperIndex];
                    var centerY1 = lineY;
                    var centerX2 = lowerStationPositions[connection.lowerIndex];
                    var centerY2 = lowerLineY;

                    var dx = centerX2 - centerX1;
                    var dy = centerY2 - centerY1;
                    var dist = Math.sqrt(dx ** 2 + dy ** 2);
                    var x3 = centerX1 + (r / dist) * dx;
                    var y3 = centerY1 + (r / dist) * dy;
                    var x4 = centerX2 - (r / dist) * dx;
                    var y4 = centerY2 - (r / dist) * dy;

                    if (connection.style == "transfer") {
                        connectionGroup.circle(2 * r)
                                       .move(centerX1 - r, centerY1 - r)
                                       .fill("white")
                                       .stroke({ color: "black", width: params.style.stationStroke });

                        connectionGroup.circle(2 * r)
                                       .move(centerX2 - r, centerY2 - r)
                                       .fill("white")
                                       .stroke({ color: "black", width: params.style.stationStroke });

                        connectionGroup.line(x3, y3, x4, y4)
                                       .stroke({ color: "black", width: params.style.stationStroke * 4 });

                        connectionGroup.line(centerX1, centerY1, centerX2, centerY2)
                                       .stroke({ color: "white", width: params.style.stationStroke * 2 });
                    } else if (connection.style == "walk") {
                        connectionGroupBack.line(x3, y3, x4, y4)
                                           .stroke({ color: "black", width: params.style.lineStroke / 2, dasharray: "12, 20", linecap: "round" });
                        connectionGroupBack.use(walkSymbol)
                                           .size(params.style.stationRadius * 2, params.style.stationRadius * 2)
                                           .move((x3 + x4) / 2 + params.style.stationRadius / 2, (y3 + y4) / 2 - params.style.stationRadius)
                    } else if (connection.style == "shuttle") {
                        connectionGroupBack.line(x3, y3, x4, y4)
                                           .stroke({ color: "black", width: params.style.lineStroke, dasharray: "15, 5" });
                    }
                }
            }

            // Add padding, including extra padding on sides if necessary
            var bbox = container.bbox();
            diagram.size(bbox.w + 2 * params.style.padding, bbox.h + 2 * params.style.padding);
            container.move(params.style.padding - bbox.x, params.style.padding - bbox.y);
        }

        var ROUTE_PATTERNS = {
            redAshmont: {
                name: "Red Line (Ashmont)",
                color: "red",
                stops: [
                    {name: "Ashmont", accessible: true, destinations: ["ALEWIFE", "ASHMONT"]},
                    {name: "Shawmut", accessible: true, destinations: ["ALEWIFE", "ASHMONT"]},
                    {name: "Fields Corner", accessible: true, destinations: ["ALEWIFE", "ASHMONT"]},
                    {name: "Savin Hill", accessible: true, destinations: ["ALEWIFE", "ASHMONT"]},
                    {name: "JFK/UMass", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Andrew", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Broadway", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "South Station", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Downtown Crossing", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Park Street", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Charles/MGH", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Kendall/MIT", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Central", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Harvard", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Porter", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Davis", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Alewife", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]}
                ],
                directions: ["Northbound", "Southbound"]
            },
            redBraintree: {
                name: "Red Line (Braintree)",
                color: "red",
                stops: [
                    {name: "Braintree", accessible: true, destinations: ["ALEWIFE", "BRAINTREE"]},
                    {name: "Quincy Adams", accessible: true, destinations: ["ALEWIFE", "BRAINTREE"]},
                    {name: "Quincy Center", accessible: true, destinations: ["ALEWIFE", "BRAINTREE"]},
                    {name: "Wollaston", accessible: true, destinations: ["ALEWIFE", "BRAINTREE"]},
                    {name: "North Quincy", accessible: true, destinations: ["ALEWIFE", "BRAINTREE"]},
                    {name: "JFK/UMass", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Andrew", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Broadway", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "South Station", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Downtown Crossing", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Park Street", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Charles/MGH", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Kendall/MIT", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Central", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Harvard", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Porter", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Davis", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Alewife", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]}
                ],
                directions: ["Northbound", "Southbound"]
            },
            mattapan: {
                name: "Mattapan Line",
                color: "red",
                stops: [
                    {name: "Mattapan", accessible: true, destinations: ["ASHMONT", "MATTAPAN"]},
                    {name: "Capen Street", accessible: true, destinations: ["ASHMONT", "MATTAPAN"]},
                    {name: "Valley Road", accessible: false, destinations: ["ASHMONT", "MATTAPAN"]},
                    {name: "Central Avenue", accessible: true, destinations: ["ASHMONT", "MATTAPAN"]},
                    {name: "Milton", accessible: true, destinations: ["ASHMONT", "MATTAPAN"]},
                    {name: "Butler", accessible: true, destinations: ["ASHMONT", "MATTAPAN"]},
                    {name: "Cedar Grove", accessible: true, destinations: ["ASHMONT", "MATTAPAN"]},
                    {name: "Ashmont", accessible: true, destinations: ["ASHMONT", "MATTAPAN"]}
                ],
                directions: ["Inbound", "Outbound"]
            },
            orange: {
                name: "Orange Line",
                color: "orange",
                stops: [
                    {name: "Forest Hills", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Green Street", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Stony Brook", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Jackson Square", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Roxbury Crossing", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Ruggles", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Massachusetts Avenue", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Back Bay", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Tufts Medical Center", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Chinatown", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Downtown Crossing", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "State", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Haymarket", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "North Station", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Community College", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Sullivan Square", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Assembly", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Wellington", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Malden Center", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Oak Grove", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]}
                ],
                directions: ["Northbound", "Southbound"]
            },
            blue: {
                name: "Blue Line",
                color: "blue",
                stops: [
                    {name: "Bowdoin", accessible: false, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Government Center", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "State", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Aquarium", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Maverick", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Airport", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Wood Island", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Orient Heights", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Suffolk Downs", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Beachmont", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Revere Beach", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Wonderland", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]}
                ],
                directions: ["Eastbound", "Westbound"]
            },
            greenB: {
                name: "Green Line (B Branch)",
                color: "green",
                stops: [
                    {name: "Boston College", accessible: true, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "South Street", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Chestnut Hill Avenue", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Chiswick Road", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Sutherland Road", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Washington Street", accessible: true, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Warren Street", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Allston Street", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Griggs Street", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Harvard Avenue", accessible: true, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Packards Corner", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Babcock Street", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Pleasant Street", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Saint Paul Street", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Boston University West", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Boston University Central", accessible: true, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Boston University East", accessible: true, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Blandford Street", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Kenmore", accessible: true, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Hynes Convention Center", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Copley", accessible: true, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Arlington", accessible: true, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Boylston", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Park Street", accessible: true, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]}
                ],
                directions: ["Eastbound", "Westbound"]
            },
            greenC: {
                name: "Green Line (C Branch)",
                color: "green",
                stops: [
                    {name: "Cleveland Circle", accessible: true, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Englewood Avenue", accessible: false, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Dean Road", accessible: false, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Tappan Street", accessible: false, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Washington Square", accessible: true, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Fairbanks Street", accessible: false, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Brandon Hall", accessible: false, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Summit Avenue", accessible: false, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Coolidge Corner", accessible: true, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Saint Paul Street", accessible: false, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Kent Street", accessible: false, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Hawes Street", accessible: false, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Saint Marys Street", accessible: true, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Kenmore", accessible: true, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Hynes Convention Center", accessible: false, destinations: ["PARK ST// & NORTH", "KENMORE// & WEST"]},
                    {name: "Copley", accessible: true, destinations: ["PARK ST// & NORTH", "KENMORE// & WEST"]},
                    {name: "Arlington", accessible: true, destinations: ["PARK ST// & NORTH", "COPLEY// & WEST"]},
                    {name: "Boylston", accessible: false, destinations: ["PARK ST// & NORTH", "COPLEY// & WEST"]},
                    {name: "Park Street", accessible: true, destinations: ["GOV CTR// & NORTH", "COPLEY// & WEST"]},
                    {name: "Government Center", accessible: true, destinations: ["NORTH STATION// & NORTH", "COPLEY// & WEST"]},
                    {name: "Haymarket", accessible: true, destinations: ["NORTH STATION// & NORTH", "COPLEY// & WEST"]},
                    {name: "North Station", accessible: true, destinations: ["NORTH STATION// & NORTH", "COPLEY// & WEST"]}
                ],
                directions: ["Eastbound", "Westbound"]
            },
            greenD: {
                name: "Green Line (D Branch)",
                color: "green",
                stops: [
                    {name: "Riverside", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Woodland", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Waban", accessible: false, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Eliot", accessible: false, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Newton Highlands", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Newton Centre", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Chestnut Hill", accessible: false, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Reservoir", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Beaconsfield", accessible: false, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Brookline Hills", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Brookline Village", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Longwood", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Fenway", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Kenmore", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Hynes Convention Center", accessible: false, destinations: ["PARK ST// & NORTH", "KENMORE// & WEST"]},
                    {name: "Copley", accessible: true, destinations: ["PARK ST// & NORTH", "KENMORE// & WEST"]},
                    {name: "Arlington", accessible: true, destinations: ["PARK ST// & NORTH", "COPLEY// & WEST"]},
                    {name: "Boylston", accessible: false, destinations: ["PARK ST// & NORTH", "COPLEY// & WEST"]},
                    {name: "Park Street", accessible: true, destinations: ["GOV CTR// & NORTH", "COPLEY// & WEST"]},
                    {name: "Government Center", accessible: true, destinations: ["GOV CTR// & NORTH", "COPLEY// & WEST"]}
                ],
                directions: ["Eastbound", "Westbound"]
            },
            greenE: {
                name: "Green Line (E Branch)",
                color: "green",
                stops: [
                    {name: "Heath Street", accessible: true, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Back of the Hill", accessible: false, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Riverway", accessible: false, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Mission Park", accessible: false, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Fenwood Road", accessible: false, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Brigham Circle", accessible: true, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Longwood Medical Area", accessible: true, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Museum of Fine Arts", accessible: true, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Northeastern University", accessible: true, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Symphony", accessible: false, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Prudential", accessible: true, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Copley", accessible: true, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Arlington", accessible: true, destinations: ["PARK ST// & NORTH", "COPLEY// & WEST"]},
                    {name: "Boylston", accessible: false, destinations: ["PARK ST// & NORTH", "COPLEY// & WEST"]},
                    {name: "Park Street", accessible: true, destinations: ["GOV CTR// & NORTH", "COPLEY// & WEST"]},
                    {name: "Government Center", accessible: true, destinations: ["NORTH STATION// & NORTH", "COPLEY// & WEST"]},
                    {name: "Haymarket", accessible: true, destinations: ["NORTH STATION// & NORTH", "COPLEY// & WEST"]},
                    {name: "North Station", accessible: true, destinations: ["LECHMERE", "COPLEY// & WEST"]},
                    {name: "Science Park", accessible: true, destinations: ["LECHMERE", "COPLEY// & WEST"]},
                    {name: "Lechmere", accessible: true, destinations: ["LECHMERE", "COPLEY// & WEST"]}
                ],
                directions: ["Eastbound", "Westbound"]
            }
        }

        function loadExample() {
            var exampleName = document.getElementById("example").value;

            if (exampleName !== null) {
                if (exampleName == "green-d") {
                    state = NEWTON_HIGHLANDS_KENMORE_STATE;
                } else if (exampleName == "haymarket") {
                    state = HAYMARKET_CLOSED_STATE;
                } else if (exampleName == "orange") {
                    state = OL_SHUTTLE_STATE;
                }

                buildDOMFromState(state);
            }
        }

        var NEWTON_HIGHLANDS_KENMORE_UPPER = {
            selected: DEFAULT_SELECTED,
            stationsText: ["NEWTON HIGHLANDS", "NEWTON CENTRE", "CHESTNUT HILL", "RESERVOIR", "BEACONSFIELD", "BROOKLINE HILLS", "BROOKLINE VILLAGE", "LONGWOOD", "FENWAY", "KENMORE"].join("\n"),
            stations: ["NEWTON HIGHLANDS", "NEWTON CENTRE", "CHESTNUT HILL", "RESERVOIR", "BEACONSFIELD", "BROOKLINE HILLS", "BROOKLINE VILLAGE", "LONGWOOD", "FENWAY", "KENMORE"],
            stationAttributes: {
                "NEWTON HIGHLANDS": { accessible: false, skipped: false, extraWidth: 0 },
                "NEWTON CENTRE": { accessible: true, skipped: false, extraWidth: 0 },
                "CHESTNUT HILL": { accessible: false, skipped: false, extraWidth: 0 },
                "RESERVOIR": { accessible: true, skipped: false, extraWidth: 0 },
                "BEACONSFIELD": { accessible: false, skipped: true, extraWidth: 0 },
                "BROOKLINE HILLS": { accessible: true, skipped: false, extraWidth: 0 },
                "BROOKLINE VILLAGE": { accessible: true, skipped: false, extraWidth: 0 },
                "LONGWOOD": { accessible: true, skipped: false, extraWidth: 0 },
                "FENWAY": { accessible: true, skipped: false, extraWidth: 0 },
                "KENMORE": { accessible: true, skipped: false, extraWidth: 0 }
            },
            leftArrow: {
                present: true,
                width: 120,
                text: "RIVERSIDE",
                color: "green"
            },
            rightArrow: {
                present: true,
                width: 120,
                text: "PARK ST//& NORTH",
                color: "green"
            },
            segmentCount: 1,
            segments: [{ fromStopIndex: 0, toStopIndex: 9, style: "shuttle" }]
        };

        var DEFAULT_LOWER = {
            selected: DEFAULT_SELECTED,
            stationsText: ["NEWTON HIGHLANDS", "NEWTON CENTRE", "CHESTNUT HILL", "RESERVOIR", "BEACONSFIELD", "BROOKLINE HILLS", "BROOKLINE VILLAGE", "LONGWOOD", "FENWAY", "KENMORE"].join("\n"),
            stations: ["NEWTON HIGHLANDS", "NEWTON CENTRE", "CHESTNUT HILL", "RESERVOIR", "BEACONSFIELD", "BROOKLINE HILLS", "BROOKLINE VILLAGE", "LONGWOOD", "FENWAY", "KENMORE"],
            stationAttributes: {
                "NEWTON HIGHLANDS": { accessible: false, skipped: false, extraWidth: 0 },
                "NEWTON CENTRE": { accessible: true, skipped: false, extraWidth: 0 },
                "CHESTNUT HILL": { accessible: false, skipped: false, extraWidth: 0 },
                "RESERVOIR": { accessible: true, skipped: false, extraWidth: 0 },
                "BEACONSFIELD": { accessible: false, skipped: true, extraWidth: 0 },
                "BROOKLINE HILLS": { accessible: true, skipped: false, extraWidth: 0 },
                "BROOKLINE VILLAGE": { accessible: true, skipped: false, extraWidth: 0 },
                "LONGWOOD": { accessible: true, skipped: false, extraWidth: 0 },
                "FENWAY": { accessible: true, skipped: false, extraWidth: 0 },
                "KENMORE": { accessible: true, skipped: false, extraWidth: 0 }
            },
            leftArrow: {
                present: true,
                width: 120,
                text: "RIVERSIDE",
                color: "green"
            },
            rightArrow: {
                present: true,
                width: 120,
                text: "PARK ST//& NORTH",
                color: "green"
            },
            segmentCount: 1,
            segments: [{ fromStopIndex: 0, toStopIndex: 9, style: "shuttle" }],
            alignment: {
                method: "left",
                offset: 0
            },
            connectionCount: 0,
            connections: []
        };

        var NEWTON_HIGHLANDS_KENMORE_STATE = {
            secondLinePresent: false,
            selectedExample: "green-d",
            width: 1000,
            downloadWidth: 2600,
            autoWidth: true,
            style: DEFAULT_STYLE,
            upper: copy(NEWTON_HIGHLANDS_KENMORE_UPPER),
            lower: {}
        };

        var HAYMARKET_CLOSED_STATE = {
            secondLinePresent: true,
            selectedExample: "haymarket",
            width: 1000,
            downloadWidth: 2600,
            autoWidth: true,
            style: DEFAULT_STYLE,
            upper: {
                selected: DEFAULT_SELECTED,
                stationsText: ["NORTH STATION", "HAYMARKET", "STATE", "DOWNTOWN CROSSING"].join("\n"),
                stations: ["NORTH STATION", "HAYMARKET", "STATE", "DOWNTOWN CROSSING"],
                stationAttributes: {
                    "NORTH STATION": { skipped: false, accessible: false, extraWidth: 0 },
                    "HAYMARKET": { skipped: false, accessible: false, extraWidth: 0 },
                    "STATE": { skipped: false, accessible: false, extraWidth: 0 },
                    "DOWNTOWN CROSSING": { skipped: false, accessible: false, extraWidth: 0 }
                },
                leftArrow: {
                    present: true,
                    width: 120,
                    text: "OAK GROVE",
                    color: "orange"
                },
                rightArrow: {
                    present: true,
                    width: 120,
                    text: "FOREST HILLS",
                    color: "orange"
                },
                segmentCount: 1,
                segments: [{ fromStopIndex: 0, toStopIndex: 3, style: "orange" }]
            },
            lower: {
                alignment: {
                    method: "left",
                    offset: 0
                },
                selected: DEFAULT_SELECTED,
                stationsText: ["NORTH STATION", "HAYMARKET", "GOVERNMENT CENTER", "PARK STREET"].join("\n"),
                stations: ["NORTH STATION", "HAYMARKET", "GOVERNMENT CENTER", "PARK STREET"],
                stationAttributes: {
                    "NORTH STATION": { skipped: false, accessible: false, extraWidth: 0 },
                    "HAYMARKET": { skipped: true, accessible: false, extraWidth: 0 },
                    "GOVERNMENT CENTER": { skipped: false, accessible: false, extraWidth: 0 },
                    "PARK STREET": { skipped: false, accessible: false, extraWidth: 0 }
                },
                leftArrow: {
                    present: true,
                    width: 120,
                    text: "LECHMERE",
                    color: "green"
                },
                rightArrow: {
                    present: true,
                    width: 120,
                    text: "COPLEY & WEST",
                    color: "green"
                },
                segmentCount: 2,
                segments: [
                    { fromStopIndex: 0, toStopIndex: 2, style: "disabled" },
                    { fromStopIndex: 2, toStopIndex: 3, style: "green" }
                ],
                alignment: {
                    method: "left",
                    offset: 0
                },
                connectionCount: 2,
                connections: [
                    { upperIndex: 0, lowerIndex: 0, style: "transfer" },
                    { upperIndex: 3, lowerIndex: 3, style: "transfer" }
                ]
            }
        };

        var OL_SHUTTLE_STATE = {
            secondLinePresent: true,
            selectedExample: "orange",
            width: 1500,
            downloadWidth: 2600,
            autoWidth: true,
            style: DEFAULT_STYLE,
            upper: {
                selected: DEFAULT_SELECTED,
                stationsText: ["NORTH STATION", "HAYMARKET", "GOVERNMENT CENTER", "PARK STREET", "BOYLSTON", "ARLINGTON", "COPLEY"].join("\n"),
                stations: ["NORTH STATION", "HAYMARKET", "GOVERNMENT CENTER", "PARK STREET", "BOYLSTON", "ARLINGTON", "COPLEY"],
                stationAttributes: {
                    "NORTH STATION": { skipped: false, accessible: true, extraWidth: 0 },
                    "HAYMARKET": { skipped: false, accessible: true, extraWidth: 0 },
                    "GOVERNMENT CENTER": { skipped: false, accessible: true, extraWidth: 0 },
                    "PARK STREET": { skipped: false, accessible: true, extraWidth: 0 },
                    "BOYLSTON": { skipped: false, accessible: false, extraWidth: 0 },
                    "ARLINGTON": { skipped: false, accessible: true, extraWidth: 0 },
                    "COPLEY": { skipped: false, accessible: true, extraWidth: 0 }
                },
                leftArrow: {
                    present: true,
                    width: 120,
                    text: "LECHMERE",
                    color: "green"
                },
                rightArrow: {
                    present: true,
                    width: 120,
                    text: "KENMORE & WEST",
                    color: "green"
                },
                segmentCount: 1,
                segments: [{ fromStopIndex: 0, toStopIndex: 6, style: "green" }]
            },
            lower: {
                selected: DEFAULT_SELECTED,
                stationsText: ["SULLIVAN SQUARE", "COMMUNITY COLLEGE", "NORTH STATION", "HAYMARKET", "STATE", "DOWNTOWN CROSSING", "CHINATOWN", "TUFTS MEDICAL CENTER", "BACK BAY"].join("\n"),
                stations: ["SULLIVAN SQUARE", "COMMUNITY COLLEGE", "NORTH STATION", "HAYMARKET", "STATE", "DOWNTOWN CROSSING", "CHINATOWN", "TUFTS MEDICAL CENTER", "BACK BAY"],
                stationAttributes: {
                    "SULLIVAN SQUARE": { accessible: true, skipped: false, extraWidth: 0 },
                    "COMMUNITY COLLEGE": { accessible: true, skipped: false, extraWidth: 0 },
                    "NORTH STATION": { accessible: true, skipped: false, extraWidth: 0 },
                    "HAYMARKET": { accessible: true, skipped: false, extraWidth: 0 },
                    "STATE": { accessible: true, skipped: true, extraWidth: 0 },
                    "DOWNTOWN CROSSING": { accessible: true, skipped: true, extraWidth: 0 },
                    "CHINATOWN": { accessible: true, skipped: true, extraWidth: 0 },
                    "TUFTS MEDICAL CENTER": { accessible: true, skipped: false, extraWidth: 0 },
                    "BACK BAY": { accessible: true, skipped: false, extraWidth: 0 }
                },
                leftArrow: {
                    present: true,
                    width: 120,
                    text: "OAK GROVE",
                    color: "orange",
                },
                rightArrow: {
                    present: true,
                    width: 120,
                    text: "FOREST HILLS",
                    color: "orange"
                },
                segmentCount: 3,
                segments: [
                    { fromStopIndex: 0, toStopIndex: 3, style: "shuttle" },
                    { fromStopIndex: 3, toStopIndex: 7, style: "disabled" },
                    { fromStopIndex: 7, toStopIndex: 8, style: "orange" },
                ],
                alignment: {
                    method: "left",
                    offset: -2
                },
                connectionCount: 3,
                connections: [
                    { upperIndex: 0, lowerIndex: 2, style: "transfer" },
                    { upperIndex: 1, lowerIndex: 3, style: "transfer" },
                    { upperIndex: 6, lowerIndex: 8, style: "walk" },
                ]
            }
        };
    </script>
</body>
</html>
