<!DOCTYPE html>
<html>
<head>
    <title>MBTA Diversion Graphic Tool</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.7.1/svg.min.js"></script>
</head>
<body>
    <div style="float: left; width: 30%;" >
        <div>
            <select id="route-pattern" onchange="selectRoutePattern()">
                <option disabled selected value> -- route pattern -- </option>
            </select>
        </div>
        <div>
            <select id="route-direction" onchange="selectDirection()">
                <option disabled selected value> -- direction -- </option>
            </select>
        </div>
        <div>
            <select id="from-stop" onchange="selectFromStop()">
                <option disabled selected value> -- from stop -- </option>
            </select>
        </div>
        <div> 
            <select id="to-stop">
                <option disabled selected value> -- to stop -- </option>
            </select>
        </div>
        <div>
            <input type="submit" id="save" value="Fill Stations" onclick="updateStations()" />
        </div>

        <br />

        <div onchange="draw()">
            <div onkeyup="updateStationList()">
                <label>Stations (one per line)</label><br />
                <textarea id="stations" cols="20" rows="12"></textarea>
            </div>
            <br />
            <div>
                <label>Width</label>
                <input type="number" id="width" value="1000" />
            </div>
            <div>
                <label>Padding</label>
                <input type="number" id="padding" value="20" />
            </div>
            <div>
                <label>Station Text Size</label>
                <input type="number" id="station-text-size" value="24" />
            </div>
            <div>
                <label>Arrow Text Size</label>
                <input type="number" id="arrow-text-size" value="16" />
            </div>
            <br />
            <div>
                <label>Left arrow?</label>
                <input type="checkbox" id="left-arrow-present" checked />
            </div>
            <div>
                <label>Left arrow width</label>
                <input type="number" id="left-arrow-width" value="120" />
            </div>
            <div>
                <label>Left arrow text</label>
                <input type="text" id="left-arrow-text" value="RIVERSIDE" />
            </div>
            <div>
                <label>Left arrow color</label>
                <select id="left-arrow-color">
                    <option value="#00843D">Green Line</option>
                    <option value="#ED8B00">Orange Line</option>
                    <option value="#DA291C">Red Line</option>
                    <option value="#003DA5">Blue Line</option>
                    <option value="#80276C">Commuter Rail</option>
                    <option value="#7C878E">Silver Line</option>
                    <option value="#FFC72C">Bus</option>
                </select>
            </div>
            <br />
            <div>
                <label>Right arrow?</label>
                <input type="checkbox" id="right-arrow-present" checked />
            </div>
            <div>
                <label>Right arrow width</label>
                <input type="number" id="right-arrow-width" value="120" />
            </div>
            <div>
                <label>Right arrow text</label>
                <input type="text" id="right-arrow-text" value="PARK ST//& NORTH" />
            </div>
            <div>
                <label>Right arrow color</label>
                <select id="right-arrow-color">
                    <option value="#00843D">Green Line</option>
                    <option value="#ED8B00">Orange Line</option>
                    <option value="#DA291C">Red Line</option>
                    <option value="#003DA5">Blue Line</option>
                    <option value="#80276C">Commuter Rail</option>
                    <option value="#7C878E">Silver Line</option>
                    <option value="#FFC72C">Bus</option>
                </select>
            </div>
            <br />
            <div>
                <label>Download width</label>
                <input type="number" id="download-width" value="2600" />
            </div>
            <div>
                <input type="submit" id="save" value="Save Diagram" onclick="save()" />
            </div>

            <br /><br />
            More options:
            <div>
                <label>Line Stroke</label>
                <input type="number" id="line-stroke" value="20" />
            </div>
            <div>
                <label>Line Dash Array</label>
                <input type="text" id="line-dash-array" value="30, 10" />
            </div>
            <div>
                <label>Line Extra Space</label>
                <input type="number" id="line-extra-space" value="6" />
            </div>
            <div>
                <label>Station Radius</label>
                <input type="number" id="station-radius" value="24" />
            </div>
            <div>
                <label>Station Stroke</label>
                <input type="number" id="station-stroke" value="6" />
            </div>
        </div>
    </div>

    <div style="position: fixed; top: 8px; left: 30%; ">
        <div id="drawing"></div>
        <br />
        <div>
            <table id="station-list" onchange="updateStationStateValues()" style="border: 1px solid black; display: inline-block;"></table>
            <div style="border: 1px solid black; display: inline-block; position: absolute; margin-left: 8px;" >
                <label>Number of segments:</label><input type="number" id="num-lines" value="1" min="1" onchange="updateNumLines()" />
                <br />
                <table id="line-list" onchange="updateLineStateValues(event)"></table>
            </div>
        </div>
    </div>

    <canvas id="canvas" style="opacity: 0;"></canvas>

    <script type="text/javascript">
        var stationState = null;
        var lineState = null;

        var ROUTE_PATTERNS = {
            redAshmont: {
                name: "Red Line (Ashmont)",
                color: "#DA291C",
                stops: [
                    {name: "Ashmont", accessible: true, destinations: ["ALEWIFE", "ASHMONT"]},
                    {name: "Shawmut", accessible: true, destinations: ["ALEWIFE", "ASHMONT"]},
                    {name: "Fields Corner", accessible: true, destinations: ["ALEWIFE", "ASHMONT"]},
                    {name: "Savin Hill", accessible: true, destinations: ["ALEWIFE", "ASHMONT"]},
                    {name: "JFK/UMass", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Andrew", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Broadway", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "South Station", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Downtown Crossing", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Park Street", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Charles/MGH", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Kendall/MIT", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Central", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Harvard", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Porter", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Davis", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Alewife", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]}
                ],
                directions: ["Northbound", "Southbound"]
            },
            redBraintree: {
                name: "Red Line (Braintree)",
                color: "#DA291C",
                stops: [
                    {name: "Braintree", accessible: true, destinations: ["ALEWIFE", "BRAINTREE"]},
                    {name: "Quincy Adams", accessible: true, destinations: ["ALEWIFE", "BRAINTREE"]},
                    {name: "Quincy Center", accessible: true, destinations: ["ALEWIFE", "BRAINTREE"]},
                    // {name: "Wollaston", accessible: true, destinations: ["ALEWIFE", "BRAINTREE"]},
                    {name: "North Quincy", accessible: true, destinations: ["ALEWIFE", "BRAINTREE"]},
                    {name: "JFK/UMass", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Andrew", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Broadway", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "South Station", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Downtown Crossing", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Park Street", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Charles/MGH", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Kendall/MIT", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Central", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Harvard", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Porter", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Davis", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]},
                    {name: "Alewife", accessible: true, destinations: ["ALEWIFE", "ASHMONT / //BRAINTREE"]}
                ],
                directions: ["Northbound", "Southbound"]
            },
            mattapan: {
                name: "Mattapan Line",
                color: "#DA291C",
                stops: [
                    {name: "Mattapan", accessible: true, destinations: ["ASHMONT", "MATTAPAN"]},
                    {name: "Capen Street", accessible: true, destinations: ["ASHMONT", "MATTAPAN"]},
                    {name: "Valley Road", accessible: false, destinations: ["ASHMONT", "MATTAPAN"]},
                    {name: "Central Avenue", accessible: true, destinations: ["ASHMONT", "MATTAPAN"]},
                    {name: "Milton", accessible: true, destinations: ["ASHMONT", "MATTAPAN"]},
                    {name: "Butler", accessible: true, destinations: ["ASHMONT", "MATTAPAN"]},
                    {name: "Cedar Grove", accessible: true, destinations: ["ASHMONT", "MATTAPAN"]},
                    {name: "Ashmont", accessible: true, destinations: ["ASHMONT", "MATTAPAN"]}
                ],
                directions: ["Inbound", "Outbound"]
            },
            orange: {
                name: "Orange Line",
                color: "#ED8B00",
                stops: [
                    {name: "Forest Hills", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Green Street", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Stony Brook", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Jackson Square", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Roxbury Crossing", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Ruggles", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Massachusetts Avenue", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Back Bay", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Tufts Medical Center", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Chinatown", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Downtown Crossing", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "State", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Haymarket", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "North Station", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Community College", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Sullivan Square", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Assembly", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Wellington", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Malden Center", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]},
                    {name: "Oak Grove", accessible: true, destinations: ["OAK GROVE", "FOREST HILLS"]}
                ],
                directions: ["Northbound", "Southbound"]
            },
            blue: {
                name: "Blue Line",
                color: "#003DA5",
                stops: [
                    {name: "Bowdoin", accessible: false, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Government Center", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "State", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Aquarium", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Maverick", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Airport", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Wood Island", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Orient Heights", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Suffolk Downs", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Beachmont", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Revere Beach", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]},
                    {name: "Wonderland", accessible: true, destinations: ["WONDERLAND", "BOWDOIN"]}
                ],
                directions: ["Eastbound", "Westbound"]
            },
            greenB: {
                name: "Green Line (B Branch)",
                color: "#00843D",
                stops: [
                    {name: "Boston College", accessible: true, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "South Street", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Chestnut Hill Avenue", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Chiswick Road", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Sutherland Road", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Washington Street", accessible: true, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Warren Street", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Allston Street", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Griggs Street", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Harvard Avenue", accessible: true, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Packards Corner", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Babcock Street", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Pleasant Street", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Saint Paul Street", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Boston University West", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Boston University Central", accessible: true, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Boston University East", accessible: true, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Blandford Street", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Kenmore", accessible: true, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Hynes Convention Center", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Copley", accessible: true, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Arlington", accessible: true, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Boylston", accessible: false, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]},
                    {name: "Park Street", accessible: true, destinations: ["PARK ST//& NORTH", "BOSTON COLLEGE"]}
                ],
                directions: ["Eastbound", "Westbound"]
            },
            greenC: {
                name: "Green Line (C Branch)",
                color: "#00843D",
                stops: [
                    {name: "Cleveland Circle", accessible: true, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Englewood Avenue", accessible: false, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Dean Road", accessible: false, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Tappan Street", accessible: false, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Washington Square", accessible: true, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Fairbanks Street", accessible: false, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Brandon Hall", accessible: false, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Summit Avenue", accessible: false, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Coolidge Corner", accessible: true, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Saint Paul Street", accessible: false, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Kent Street", accessible: false, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Hawes Street", accessible: false, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Saint Marys Street", accessible: true, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Kenmore", accessible: true, destinations: ["PARK ST// & NORTH", "CLEVELAND CIRCLE"]},
                    {name: "Hynes Convention Center", accessible: false, destinations: ["PARK ST// & NORTH", "KENMORE// & WEST"]},
                    {name: "Copley", accessible: true, destinations: ["PARK ST// & NORTH", "KENMORE// & WEST"]},
                    {name: "Arlington", accessible: true, destinations: ["PARK ST// & NORTH", "COPLEY// & WEST"]},
                    {name: "Boylston", accessible: false, destinations: ["PARK ST// & NORTH", "COPLEY// & WEST"]},
                    {name: "Park Street", accessible: true, destinations: ["GOV CTR// & NORTH", "COPLEY// & WEST"]},
                    {name: "Government Center", accessible: true, destinations: ["NORTH STATION// & NORTH", "COPLEY// & WEST"]},
                    {name: "Haymarket", accessible: true, destinations: ["NORTH STATION// & NORTH", "COPLEY// & WEST"]},
                    {name: "North Station", accessible: true, destinations: ["NORTH STATION// & NORTH", "COPLEY// & WEST"]}
                ],
                directions: ["Eastbound", "Westbound"]
            },
            greenD: {
                name: "Green Line (D Branch)",
                color: "#00843D",
                stops: [
                    {name: "Riverside", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Woodland", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Waban", accessible: false, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Eliot", accessible: false, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Newton Highlands", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Newton Centre", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Chestnut Hill", accessible: false, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Reservoir", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Beaconsfield", accessible: false, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Brookline Hills", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Brookline Village", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Longwood", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Fenway", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Kenmore", accessible: true, destinations: ["PARK ST// & NORTH", "RIVERSIDE"]},
                    {name: "Hynes Convention Center", accessible: false, destinations: ["PARK ST// & NORTH", "KENMORE// & WEST"]},
                    {name: "Copley", accessible: true, destinations: ["PARK ST// & NORTH", "KENMORE// & WEST"]},
                    {name: "Arlington", accessible: true, destinations: ["PARK ST// & NORTH", "COPLEY// & WEST"]},
                    {name: "Boylston", accessible: false, destinations: ["PARK ST// & NORTH", "COPLEY// & WEST"]},
                    {name: "Park Street", accessible: true, destinations: ["GOV CTR// & NORTH", "COPLEY// & WEST"]},
                    {name: "Government Center", accessible: true, destinations: ["GOV CTR// & NORTH", "COPLEY// & WEST"]}
                ],
                directions: ["Eastbound", "Westbound"]
            },
            greenE: {
                name: "Green Line (E Branch)",
                color: "#00843D",
                stops: [
                    {name: "Heath Street", accessible: true, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Back of the Hill", accessible: false, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Riverway", accessible: false, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Mission Park", accessible: false, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Fenwood Road", accessible: false, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Brigham Circle", accessible: true, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Longwood Medical Area", accessible: true, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Museum of Fine Arts", accessible: true, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Northeastern University", accessible: true, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Symphony", accessible: false, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Prudential", accessible: true, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Copley", accessible: true, destinations: ["PARK ST// & NORTH", "HEATH STREET"]},
                    {name: "Arlington", accessible: true, destinations: ["PARK ST// & NORTH", "COPLEY// & WEST"]},
                    {name: "Boylston", accessible: false, destinations: ["PARK ST// & NORTH", "COPLEY// & WEST"]},
                    {name: "Park Street", accessible: true, destinations: ["GOV CTR// & NORTH", "COPLEY// & WEST"]},
                    {name: "Government Center", accessible: true, destinations: ["NORTH STATION// & NORTH", "COPLEY// & WEST"]},
                    {name: "Haymarket", accessible: true, destinations: ["NORTH STATION// & NORTH", "COPLEY// & WEST"]},
                    {name: "North Station", accessible: true, destinations: ["LECHMERE", "COPLEY// & WEST"]},
                    {name: "Science Park", accessible: true, destinations: ["LECHMERE", "COPLEY// & WEST"]},
                    {name: "Lechmere", accessible: true, destinations: ["LECHMERE", "COPLEY// & WEST"]}
                ],
                directions: ["Eastbound", "Westbound"]
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            // Default values (Newton Highlands / Kenmore)
            document.getElementById("stations").value = "NEWTON HIGHLANDS\nNEWTON CENTRE\nCHESTNUT HILL\nRESERVOIR\nBEACONSFIELD\nBROOKLINE HILLS\nBROOKLINE VILLAGE\nLONGWOOD\nFENWAY\nKENMORE";

            // Set route pattern select values
            updateRoutePatterns();

            stationState = {
                "NEWTON HIGHLANDS": { accessible: false, skipped: false },
                "NEWTON CENTRE": { accessible: true, skipped: false },
                "CHESTNUT HILL": { accessible: false, skipped: false },
                "RESERVOIR": { accessible: true, skipped: false },
                "BEACONSFIELD": { accessible: false, skipped: true },
                "BROOKLINE HILLS": { accessible: true, skipped: false },
                "BROOKLINE VILLAGE": { accessible: true, skipped: false },
                "LONGWOOD": { accessible: true, skipped: false },
                "FENWAY": { accessible: true, skipped: false },
                "KENMORE": { accessible: true, skipped: false },
            }
            updateStationList();
            updateNumLines();

            // Draw and automatically set arrow widths
            draw(true);
        });

        function updateRoutePatterns() {
            var select = document.getElementById("route-pattern");

            for (var routePatternId in ROUTE_PATTERNS) {
                var routePattern = ROUTE_PATTERNS[routePatternId];
                var elt = document.createElement("option");
                elt.value = routePatternId;
                elt.innerHTML = routePattern.name;
                select.appendChild(elt);
            }
        }

        function selectRoutePattern() {
            var routePatternId = document.getElementById("route-pattern").value;
            var routePattern = ROUTE_PATTERNS[routePatternId];
            var directions = routePattern.directions;

            var select = document.getElementById("route-direction");
            select.innerHTML = "";
            for (var i = 0; i < directions.length; i++) {
                var elt = document.createElement("option");
                elt.value = directions[i];
                elt.innerHTML = directions[i];
                select.appendChild(elt);
            }

            selectDirection();
        }

        function selectDirection() {
            var routePatternId = document.getElementById("route-pattern").value;
            var direction = document.getElementById("route-direction").value;
            var routePattern = ROUTE_PATTERNS[routePatternId];

            var directions = routePattern.directions;
            var stops = routePattern.stops.slice(0);

            if (direction == directions[1]) {
                stops.reverse();
            }

            var select = document.getElementById("from-stop");
            select.innerHTML = "";
            for (var i = 0; i < stops.length; i++) {
                var stop = stops[i];
                var elt = document.createElement("option");
                elt.value = stop.name.toUpperCase();
                elt.innerHTML = stop.name.toUpperCase();
                select.appendChild(elt);
            }

            selectFromStop();
        }

        function selectFromStop() {
            var routePatternId = document.getElementById("route-pattern").value;
            var direction = document.getElementById("route-direction").value;
            var fromStop = document.getElementById("from-stop").value;
            var routePattern = ROUTE_PATTERNS[routePatternId];
            var directions = routePattern.directions;
            var stops = routePattern.stops.slice(0);

            if (direction == directions[1]) {
                stops.reverse();
            }

            var foundStop = false;
            var select = document.getElementById("to-stop");
            select.innerHTML = "";
            for (var i = 0; i < stops.length; i++) {
                var stop = stops[i];

                if (foundStop) {
                    var elt = document.createElement("option");
                    elt.value = stop.name.toUpperCase();
                    elt.innerHTML = stop.name.toUpperCase();
                    select.appendChild(elt);
                }

                if (stop.name.toUpperCase() === fromStop) {
                    foundStop = true;
                }
            }
        }

        function updateStations() {
            var routePatternId = document.getElementById("route-pattern").value;
            var direction = document.getElementById("route-direction").value;
            var fromStop = document.getElementById("from-stop").value;
            var toStop = document.getElementById("to-stop").value;
            var routePattern = ROUTE_PATTERNS[routePatternId];
            var directions = routePattern.directions;
            var stops = routePattern.stops.slice(0);

            if (direction == directions[1]) {
                stops.reverse();
            }

            var foundFromStop = false;
            var foundToStop = false;
            var includesFirstStop = false;
            var includesLastStop = false;
            var leftArrowText = null;
            var rightArrowText = null;

            var stations = [];
            var accessibleStations = [];
            for (var i = 0; i < stops.length; i++) {
                var stop = stops[i];

                if (stop.name.toUpperCase() === fromStop) {
                    foundFromStop = true;
                    leftArrowText = (direction == directions[0]) ? stop.destinations[1] : stop.destinations[0];
                }

                if (foundFromStop && !foundToStop) {
                    stations.push(stop.name.toUpperCase());
                    if (stop.accessible === true) {
                        accessibleStations.push(stop.name.toUpperCase());
                    }

                    if (i == 0) {
                        includesFirstStop = true;
                    }

                    if (i == stops.length - 1) {
                        includesLastStop = true;
                    }
                }

                if (stop.name.toUpperCase() === toStop) {
                    foundToStop = true;
                    rightArrowText = (direction == directions[0]) ? stop.destinations[0] : stop.destinations[1];
                }
            }

            document.getElementById("stations").value = stations.join("\n");
            document.getElementById("left-arrow-color").value = routePattern.color;
            document.getElementById("right-arrow-color").value = routePattern.color;

            if (includesFirstStop) {
                document.getElementById("left-arrow-present").checked = false;
            } else {
                document.getElementById("left-arrow-present").checked = true;
                document.getElementById("left-arrow-text").value = leftArrowText;
            }

            if (includesLastStop) {
                document.getElementById("right-arrow-present").checked = false;
            } else {
                document.getElementById("right-arrow-present").checked = true;
                document.getElementById("right-arrow-text").value = rightArrowText;
            }

            stationState = null;
            updateStationList();

            lineState = null;
            document.getElementById("num-lines").value = 1;
            updateNumLines();

            // Draw and automatically set widths
            draw(true);
        }

        // Adapted from https://stackoverflow.com/questions/28226677/save-inline-svg-as-jpeg-png-svg
        function save() {
            draw();

            var downloadWidth = parseInt(document.getElementById("download-width").value);

            var svg = document.querySelector('svg');
            var svgWidth = svg.width.baseVal.value;
            var svgHeight = svg.height.baseVal.value;
            var scaleFactor = downloadWidth / svgWidth;

            var canvas = document.getElementById('canvas');
            canvas.width = svgWidth * scaleFactor;
            canvas.height = svgHeight * scaleFactor;

            var ctx = canvas.getContext('2d');
            ctx.scale(scaleFactor, scaleFactor);
            var data = (new XMLSerializer()).serializeToString(svg);

            var DOMURL = window.URL || window.webkitURL || window;

            var img = new Image();
            var svgBlob = new Blob([data], {type: 'image/svg+xml;charset=utf-8'});
            var url = DOMURL.createObjectURL(svgBlob);

            img.onload = function () {
                ctx.drawImage(img, 0, 0);
                DOMURL.revokeObjectURL(url);

                var imgURI = canvas
                    .toDataURL('image/png')
                    .replace('image/png', 'image/octet-stream');

                var evt = new MouseEvent('click', {
                    view: window,
                    bubbles: false,
                    cancelable: true
                });

                var a = document.createElement('a');
                a.setAttribute('download', 'shuttle-diagram.png');
                a.setAttribute('href', imgURI);
                a.setAttribute('target', '_blank');

                a.dispatchEvent(evt);
            };

            img.src = url;
        }

        function parseColor(color) {
            if (color == "green") { return "#00843D"; }
            if (color == "orange") { return "#ED8B00"; }
            if (color == "red") { return "#DA291C"; }
            if (color == "blue") { return "#003DA5"; }
            if (color == "purple" || color == "CR") { return "#80276C"; }
            if (color == "silver") { return "#7C878E"; }
            if (color == "bus") { return "#FFC72C"; }

            return "black";
        }

        function copy(obj) {
            return JSON.parse(JSON.stringify(obj));
        }

        var COLUMNS = ["accessible", "skipped"];

        function updateStationList() {
            var stations = document.getElementById("stations").value.trim().split("\n");
            var stationList = document.getElementById("station-list");
            stationList.innerHTML = "";

            if (stationState !== null) {
                var stateOnly = [];
                var arrayOnly = [];

                // Find station in state which is not in array
                for (station in stationState) {
                    if (!stations.includes(station)) {
                        stateOnly.push(station);
                    }
                }

                // Find station in array which is not in state
                for (var i = 0; i < stations.length; i++) {
                    if (stationState[stations[i]] === undefined) {
                        arrayOnly.push(stations[i]);
                    }
                }

                // If either stateOnly or arrayOnly has more than one element, something strange
                // has happened (maybe copy/paste) and we don't know what to do, so reset.
                if (arrayOnly.length > 1 || stateOnly.length > 1) {
                    stationState = null;
                } else {
                    arrayOnly = arrayOnly[0];
                    stateOnly = stateOnly[0];

                    if ((arrayOnly !== undefined) && (stateOnly !== undefined)) {
                        // Change
                        stationState[arrayOnly] = copy(stationState[stateOnly]);
                        delete stationState[stateOnly];
                    } else if (arrayOnly !== undefined) {
                        // Addition
                        stationState[arrayOnly] = { checked: false };
                    } else if (stateOnly !== undefined) {
                        // Deletion
                        delete stationState[stateOnly];
                    }
                }
            }

            if (stationState === null) {
                stationState = {};
                for (var i = 0; i < stations.length; i++) {
                    stationState[stations[i]] = {};
                    for (var j = 0; j < COLUMNS.length; j++) {
                        stationState[stations[i]][COLUMNS[j]] = false;
                    }
                }
            }
            
            // header row
            var rowElement = document.createElement("tr");
            var cell = document.createElement("td");
            cell.innerHTML = "station name";
            rowElement.appendChild(cell);
            for (var i = 0; i < COLUMNS.length; i++) {
                var cell = document.createElement("td");
                cell.innerHTML = COLUMNS[i];
                rowElement.appendChild(cell);
            }
            stationList.appendChild(rowElement);

            // input rows
            for (var i = 0; i < stations.length; i++) {
                var rowElement = document.createElement("tr");
                var nameCell = document.createElement("td");
                nameCell.innerHTML = stations[i];
                rowElement.appendChild(nameCell);

                for (var j = 0; j < COLUMNS.length; j++) {
                    var cell = document.createElement("td");
                    var checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.id = "station-" + i.toString() + "-" + COLUMNS[j];
                    checkbox.checked = stationState[stations[i]][COLUMNS[j]];
                    cell.appendChild(checkbox);
                    rowElement.appendChild(cell);
                }
                
                stationList.appendChild(rowElement);
            }

            updateNumLines();
        }

        function updateStationStateValues() {
            var stations = document.getElementById("stations").value.trim().split("\n");
            var stationList = document.getElementById("station-list");

            for (var i = 0; i < stations.length; i++) {
                var stationPrefix = "station-" + i.toString() + "-";
                for (var j = 0; j < COLUMNS.length; j++) {
                    var checkbox = document.getElementById(stationPrefix + COLUMNS[j]);
                    stationState[stations[i]][COLUMNS[j]] = checkbox.checked;
                }
            }

            draw();
        }

        function createStopDropdown(id) {
            var stations = document.getElementById("stations").value.trim().split("\n");
            var selectElt = document.createElement("select");
            selectElt.id = id;

            for (var i = 0; i < stations.length; i++) {
                var optionElt = document.createElement("option");
                optionElt.value = i;
                optionElt.innerHTML = stations[i];
                selectElt.appendChild(optionElt);
            }

            return selectElt;
        }

        function createStyleDropdown(id) {
            var selectElt = document.createElement("select");
            selectElt.id = id;

            var options = ["shuttle", "red", "orange", "green", "blue", "CR", "silver", "bus"];
            for (var i = 0; i < options.length; i++) {
                var optionElt = document.createElement("option");
                optionElt.value = options[i];
                optionElt.innerHTML = options[i];
                selectElt.appendChild(optionElt);
            }

            return selectElt;
        }

        function updateNumLines() {
            var stations = document.getElementById("stations").value.trim().split("\n");
            if (lineState === null) {
                var lineStroke = parseInt(document.getElementById("line-stroke").value);
                var lineDashArray = document.getElementById("line-dash-array").value;

                lineState = [{fromStop: 0, toStop: stations.length - 1, style: "shuttle", color: "black", width: lineStroke, dasharray: lineDashArray}]
            }

            var numLines = parseInt(document.getElementById("num-lines").value);
            var lineTable = document.getElementById("line-list");
            lineTable.innerHTML = "";

            var LINE_COLUMNS = ["fromStop", "toStop", "style"];

            // header row
            var rowElement = document.createElement("tr");
            for (var i = 0; i < LINE_COLUMNS.length; i++) {
                var cell = document.createElement("td");
                cell.innerHTML = LINE_COLUMNS[i];
                rowElement.appendChild(cell);
            }

            lineTable.appendChild(rowElement);

            // input rows
            for (var i = 0; i < numLines; i++) {
                var rowElement = document.createElement("tr");
                for (var j = 0; j < LINE_COLUMNS.length; j++) {
                    var cell = document.createElement("td");
                    if (LINE_COLUMNS[j] == "fromStop" || LINE_COLUMNS[j] == "toStop") {
                        cell.appendChild(createStopDropdown(i.toString() + "-" + LINE_COLUMNS[j]));
                    } else if (LINE_COLUMNS[j] == "style") {
                        cell.appendChild(createStyleDropdown(i.toString() + "-" + LINE_COLUMNS[j]))
                    }
                    rowElement.appendChild(cell);
                }

                lineTable.appendChild(rowElement);
            }

            if (lineState.length == numLines) {
                for (var i = 0; i < lineState.length; i++) {
                    for (var j = 0; j < LINE_COLUMNS.length; j++) {
                        var id = i.toString() + "-" + LINE_COLUMNS[j];
                        var elt = document.getElementById(id);
                        var val = lineState[i][LINE_COLUMNS[j]];
                        var opt = elt.querySelector('option[value="' + val + '"]');
                        if (opt !== null) {
                            opt.selected = true;
                        }
                    }
                }
            } else if (lineState.length > numLines) {
                for (var i = 0; i < numLines - 1; i++) {
                    for (var j = 0; j < LINE_COLUMNS.length; j++) {
                        var id = i.toString() + "-" + LINE_COLUMNS[j];
                        var elt = document.getElementById(id);
                        var val = lineState[i][LINE_COLUMNS[j]];
                        elt.querySelector('option[value="' + val + '"]').selected = true;
                    }
                }

                // Special case last line
                var i = numLines - 1;
                var fromStopElt = document.getElementById(i.toString() + "-fromStop");
                fromStopElt.querySelector('option[value="' + lineState[i].fromStop + '"]').selected = true;

                var toStopElt = document.getElementById(i.toString() + "-toStop");
                toStopElt.querySelector('option[value="' + (stations.length - 1).toString() + '"]').selected = true;

                var styleElt = document.getElementById(i.toString() + "-style");
                styleElt.querySelector('option[value="' + lineState[i].style + '"]').selected = true;
            } else if (lineState.length < numLines) {
                for (var i = 0; i < lineState.length; i++) {
                    for (var j = 0; j < LINE_COLUMNS.length; j++) {
                        var id = i.toString() + "-" + LINE_COLUMNS[j];
                        var elt = document.getElementById(id);
                        var val = lineState[i][LINE_COLUMNS[j]];
                        elt.querySelector('option[value="' + val + '"]').selected = true;
                    }
                }

                for (var i = lineState.length; i < numLines; i++) {
                    var fromStopElt = document.getElementById(i.toString() + "-fromStop");
                    fromStopElt.querySelector('option[value="' + (stations.length - 1).toString() + '"]').selected = true;

                    var toStopElt = document.getElementById(i.toString() + "-toStop");
                    toStopElt.querySelector('option[value="' + (stations.length - 1).toString() + '"]').selected = true;

                    var styleElt = document.getElementById(i.toString() + "-style");
                    styleElt.querySelector('option[value="shuttle"]').selected = true;
                }
            }

            updateLineStateValues();
        }

        function updateLineStateValues(event) {
            var numLines = parseInt(document.getElementById("num-lines").value);

            // If updating a toStop, also update the next fromStop
            if (event !== undefined && event.target.id.includes("toStop")) {
                var idx = parseInt(event.target.id.split("-")[0]);
                if (idx < numLines - 1) {
                    var nextElt = document.getElementById((idx + 1).toString() + "-fromStop");
                    nextElt.value = event.target.value;
                }
            }

            // If updating a fromStop, also update the previous toStop
            if (event !== undefined && event.target.id.includes("fromStop")) {
                var idx = parseInt(event.target.id.split("-")[0]);
                if (idx > 0) {
                    var prevElt = document.getElementById((idx - 1).toString() + "-toStop");
                    prevElt.value = event.target.value;
                }
            }

            
            var parsedLines = [];

            for (var i = 0; i < numLines; i++) {
                var fromStop = parseInt(document.getElementById(i.toString() + "-fromStop").value);
                var toStop = parseInt(document.getElementById(i.toString() + "-toStop").value);
                var style = document.getElementById(i.toString() + "-style").value;

                if (fromStop < toStop) {
                    var parsedLine = {};
                    parsedLine.fromStop = fromStop;
                    parsedLine.toStop = toStop;
                    parsedLine.style = style;

                    if (["red", "orange", "green", "blue", "purple", "CR", "silver", "bus"].includes(style)) {
                        var stationRadius = parseInt(document.getElementById("station-radius").value);
                        parsedLine.color = parseColor(style);
                        parsedLine.width = stationRadius * 2;
                    } else if (style == "shuttle") {
                        var lineStroke = parseInt(document.getElementById("line-stroke").value);
                        var lineDashArray = document.getElementById("line-dash-array").value;
                        parsedLine.color = "black";
                        parsedLine.width = lineStroke;
                        parsedLine.dasharray = lineDashArray;
                    }

                    parsedLines.push(parsedLine);
                }
            }

            if (parsedLines.length > 0) {
                lineState = parsedLines;
            } else {
                var lineStroke = parseInt(document.getElementById("line-stroke").value);
                var lineDashArray = document.getElementById("line-dash-array").value;
                var stations = document.getElementById("stations").value.trim().split("\n");
                lineState = [{fromStop: 0, toStop: stations.length - 1, style: "shuttle", color: "black", width: lineStroke, dasharray: lineDashArray}];
            }

            draw();
        }

        function draw(setWidths) {
            // Clear existing diagram
            document.getElementById("drawing").innerHTML = "";

            // Get inputs
            var padding = parseInt(document.getElementById("padding").value);
            var width = parseInt(document.getElementById("width").value);
            var lineExtraSpace = parseInt(document.getElementById("line-extra-space").value);

            var stations = document.getElementById("stations").value.trim().split("\n");
            // var accessibleStations = document.getElementById("accessible-stations").value.trim().split("\n");
            // var skippedStations = document.getElementById("skipped-stations").value.trim().split("\n");

            var arrowTextSize = parseInt(document.getElementById("arrow-text-size").value);
            var leftArrow = document.getElementById("left-arrow-present").checked;
            var leftArrowWidth = parseInt(document.getElementById("left-arrow-width").value);
            var leftArrowColor = document.getElementById("left-arrow-color").value;
            var leftArrowText = document.getElementById("left-arrow-text").value;
            var leftArrowTextColor = (leftArrowColor == "#FFC72C") ? "black" : "white";

            var rightArrow = document.getElementById("right-arrow-present").checked;
            var rightArrowWidth = parseInt(document.getElementById("right-arrow-width").value);
            var rightArrowColor = document.getElementById("right-arrow-color").value;
            var rightArrowText = document.getElementById("right-arrow-text").value;
            var rightArrowTextColor = (rightArrowColor == "#FFC72C") ? "black" : "white";

            var lineStroke = parseInt(document.getElementById("line-stroke").value);
            var lineDashArray = document.getElementById("line-dash-array").value;
            var stationRadius = parseInt(document.getElementById("station-radius").value);
            var stationStroke = parseInt(document.getElementById("station-stroke").value);
            var stationTextSize = parseInt(document.getElementById("station-text-size").value);
            var RT2 = Math.sqrt(2);

            // Create SVG
            var diagram = SVG('drawing')
                .size(width, 100)
                .style({
                    "background-color": "white",
                    "outline": "1px solid black"
                });

            // Put everything inside container so it can be moved later to add padding
            var container = diagram.group();

            // Create groups in the right order
            var textGroup = container.group();
            var lineGroup = container.group();
            var stationGroup = container.group();
            if (leftArrow) { var leftArrowGroup = container.group(); }
            if (rightArrow) { var rightArrowGroup = container.group(); }

            // ISA Symbol from Wikipedia
            var isaSymbol = diagram.symbol();
            isaSymbol.path("M161.9882813,98.1240234 c24.9628906-2.3046875,44.3574219-23.8110352,44.3574219-48.9658203C206.3457031,22.0830078,184.2626953,0,157.1875,0 s-49.1572266,22.0830078-49.1572266,49.1582031c0,8.2568359,2.3037109,16.7055664,6.1445313,23.8105469l17.515625,246.4667969 l180.3964844,0.0488281l73.9912109,173.3652344l97.1445313-38.0976563l-15.0429688-35.8203125l-54.3662109,19.625 l-71.5908203-165.2802734l-167.7294922,1.1269531l-2.3027344-31.2128906l121.4228516,0.0483398v-46.1831055l-126.0546875-0.0493164 L161.9882813,98.1240234z").fill("black");
            isaSymbol.path("M343.4199219,451.5908203 c-30.4472656,60.1875-94.1748047,99.8398438-162.1503906,99.8398438C81.4296875,551.4306641,0,470.0009766,0,370.1611328 c0-70.1005859,42.4853516-135.2436523,105.8818359-164.1210938l4.1025391,53.5375977 c-37.4970703,23.628418-60.6123047,66.262207-60.6123047,110.9506836c0,72.4267578,59.0712891,131.4970703,131.4970703,131.4970703 c66.2617188,0,122.7646484-50.8515625,130.4697266-116.0869141L343.4199219,451.5908203z").fill("black");
            isaSymbol.viewbox(0, 0, 483.2226563, 551.4306641);
            isaSymbol.size(stationTextSize, stationTextSize);


            if (leftArrow) {
                // Text label
                var leftArrowTextLines = leftArrowText.split("//");
                var leftArrowTextElt = leftArrowGroup
                    .text(function(add) {
                        for (var i = 0; i < leftArrowTextLines.length; i++) {
                            add.tspan(leftArrowTextLines[i]).newLine();
                        }
                    })
                    .stroke("none")
                    .fill(leftArrowTextColor)
                    .font({
                        weight: "bold",
                        size: arrowTextSize + "px",
                        family: "sans-serif",
                        anchor: "middle"
                    });
            }

            if (rightArrow) {
                // Text label
                var rightArrowTextLines = rightArrowText.split("//");
                var rightArrowTextElt = diagram
                    .text(function(add) {
                        for (var i = 0; i < rightArrowTextLines.length; i++) {
                            add.tspan(rightArrowTextLines[i]).newLine();
                        }
                    })
                    .stroke("none")
                    .fill(rightArrowTextColor)
                    .font({
                        weight: "bold",
                        size: arrowTextSize + "px",
                        family: "sans-serif",
                        anchor: "middle"
                    })
            }

            if (setWidths) {
                // Compute new widths
                if (leftArrow) {
                    leftArrowWidth = Math.round(leftArrowTextElt.bbox().w + stationRadius * 2);
                    document.getElementById("left-arrow-width").value = leftArrowWidth;
                }

                if (rightArrow) {
                    rightArrowWidth = Math.round(rightArrowTextElt.bbox().w + stationRadius * 2);
                    document.getElementById("right-arrow-width").value = rightArrowWidth;
                }
            }

            ///////////////////////////////////////////////////////////////////
            // Compute startX, endX, stationDX
            ///////////////////////////////////////////////////////////////////
            var startX = stationRadius;
            var endX = width - stationRadius;
            if (leftArrow) { startX += leftArrowWidth };
            if (rightArrow) { endX -= rightArrowWidth };

            var stationDX = 0;
            if (stations.length > 1) {
                stationDX = (endX - startX) / (stations.length - 1);
            }

            ///////////////////////////////////////////////////////////////////
            // Draw lines
            ///////////////////////////////////////////////////////////////////
            for (var i = 0; i < lineState.length; i++) {
                var x1 = startX + stationDX * lineState[i].fromStop;
                var x2 = startX + stationDX * lineState[i].toStop;
                var lineStroke = {color: lineState[i].color, width: lineState[i].width}
                if (lineState[i].dasharray) { lineStroke.dasharray = lineState[i].dasharray };
                lineGroup.line(x1, 0, x2, 0).stroke(lineStroke)
            }

            ///////////////////////////////////////////////////////////////////
            // Draw stations
            ///////////////////////////////////////////////////////////////////
            for (var i = 0; i < stations.length; i++) {
                var centerX = startX + i * stationDX;
                var centerY = 0;
                var r = stationRadius - stationStroke / 2;

                if (stationState[stations[i]].skipped) {
                    // Red Octagon for skipped stop
                    var side = 2 * r / (1 + RT2);
                    var points = [
                        [(side / 2 * (1 + RT2)), (side / 2)],
                        [(side / 2), (side / 2 * (1 + RT2))],
                        [(-side / 2), (side / 2 * (1 + RT2))],
                        [(-side / 2 * (1 + RT2)), (side / 2)],
                        [(-side / 2 * (1 + RT2)), (-side / 2)],
                        [(-side / 2), (-side / 2 * (1 + RT2))],
                        [(side / 2), (-side / 2 * (1 + RT2))],
                        [(side / 2 * (1 + RT2)), (-side / 2)],
                    ];

                    stationGroup.polygon(points.join(" "))
                                .move(centerX - r, centerY - r)
                                .fill("red")
                                .stroke({color: "red", width: stationStroke});

                    stationGroup.line(-r/2, -r/2, r/2, r/2)
                                .move(centerX - r/2, centerY - r/2)
                                .stroke({ color: "white", width: stationRadius / 3});

                    stationGroup.line(-r/2, r/2, r/2, -r/2)
                                .move(centerX - r/2, centerY - r/2)
                                .stroke({ color: "white", width: stationRadius / 3});
                } else {
                    // Circle for normal stop

                    for (var j = 0; j < lineState.length; j++) {
                        if (i > lineState[j].fromStop && i <= lineState[j].toStop) {
                            var stopStrokeColor = lineState[j].color;

                            if ((stopStrokeColor == "black") && (j < lineState.length - 1) && (i == lineState[j].toStop)) {
                                stopStrokeColor = lineState[j + 1].color;
                            }
                        }
                    }

                    stationGroup.circle(2*r)
                                .move(centerX - r, centerY - r)
                                .fill("white")
                                .stroke({ color: stopStrokeColor, width: stationStroke});
                }

                // Station label
                var stationTextAngle = 315;
                var text = textGroup
                    .text(function(add) {
                        add.tspan(stations[i]).newLine();
                    })
                    .rotate(stationTextAngle, centerX - stationTextSize / 2, 0)
                    .move(centerX - stationTextSize / 2, 0)
                    .font({
                        family: "sans-serif",
                        weight: "bold",
                        size: stationTextSize + "px"
                    });

                // Station accessibility label
                if (stationState[stations[i]].accessible) {
                    var ISAX = centerX - stationTextSize / 2
                        + (text.length() + stationTextSize / 4) * Math.cos(stationTextAngle * Math.PI / 180);
                    var ISAY = (text.length() + stationTextSize / 4) * Math.sin(stationTextAngle * Math.PI / 180);
                    textGroup.use(isaSymbol)
                             .rotate(stationTextAngle, ISAX, ISAY)
                             .move(ISAX, ISAY);
                }
            }

            // Used measured element heights to set Y coordinates of groups
            var measuredTextHeight = textGroup.bbox().h;
            var measuredLineHeight = stationGroup.bbox().h;
            var lineY = measuredTextHeight + measuredLineHeight / 2 + lineExtraSpace;

            lineGroup.move(0, lineY);
            stationGroup.move(0, lineY);
            textGroup.move(0, measuredTextHeight - stationTextSize);
            diagram.size(width, measuredTextHeight + measuredLineHeight);

            ///////////////////////////////////////////////////////////////////
            // Draw left arrow
            ///////////////////////////////////////////////////////////////////
            if (leftArrow) {
                // Arrow
                var dy = stationRadius - stationStroke / 2;
                var points = [
                    [stationStroke / RT2, lineY],
                    [stationRadius, lineY + dy],
                    [leftArrowWidth + stationRadius, lineY + dy],
                    [leftArrowWidth + stationRadius, lineY - dy],
                    [stationRadius, (lineY - dy)]
                ];


                leftArrowGroup.polygon(points.join(" "))
                              .fill(leftArrowColor)
                              .stroke({color: leftArrowColor, width: stationStroke});

                // Circle
                var centerX = startX;
                var centerY = lineY;
                var r = stationRadius - stationStroke / 2;  
                leftArrowGroup.circle(2 * r)
                              .move(centerX - r, centerY - r)
                              .fill("white")
                              .stroke({ color: leftArrowColor, width: stationStroke});

                leftArrowGroup.add(leftArrowTextElt);

                // Adjust position based on measured height and width
                var leftArrowTextX = stationRadius + leftArrowTextElt.bbox().w / 2;
                var leftArrowTextY = lineY - leftArrowTextElt.bbox().h / 2;
                leftArrowTextElt.move(leftArrowTextX, leftArrowTextY);
            }

            ///////////////////////////////////////////////////////////////////
            // Draw right arrow
            ///////////////////////////////////////////////////////////////////
            if (rightArrow) {
                // Arrow
                var dy = stationRadius - stationStroke / 2;
                var points = [
                    [width - stationStroke / RT2, lineY],
                    [width - stationRadius, lineY + dy],
                    [width - rightArrowWidth - stationRadius, lineY + dy],
                    [width - rightArrowWidth - stationRadius, lineY - dy],
                    [width - stationRadius, lineY - dy],
                ];

                rightArrowGroup.polygon(points.join(" "))
                               .fill(rightArrowColor)
                               .stroke({color: rightArrowColor, width: stationStroke});

                // Circle
                var centerX = endX;
                var centerY = lineY;
                var r = stationRadius - stationStroke / 2;
                rightArrowGroup.circle(2 * r)
                               .move(centerX - r, centerY - r)
                               .fill("white")
                               .stroke({ color: rightArrowColor, width: stationStroke});

                rightArrowGroup.add(rightArrowTextElt);
                

                // Adjust position based on measured height and width
                var rightArrowTextX = width - stationRadius - rightArrowTextElt.bbox().w / 2;
                var rightArrowTextY = lineY - rightArrowTextElt.bbox().h / 2;
                rightArrowTextElt.move(rightArrowTextX, rightArrowTextY);
            }

            // Add padding, including extra padding on RHS if necessary
            var lastTextEndX = textGroup.bbox().x2;
            var measuredWidth = Math.max(width, lastTextEndX);
            var measuredHeight = measuredTextHeight + measuredLineHeight + lineExtraSpace;
            diagram.size(measuredWidth + 2 * padding, measuredHeight + 2 * padding);
            container.move(padding, padding);
        }
    </script>
</body>
</html>
